<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Gaming Tournament</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Dark Theme Variables --- */
        :root {
            --primary-bg: #0F172A; /* Slate 900 */
            --secondary-bg: #1E293B; /* Slate 800 */
            --card-bg: #1E293B; /* Slate 800 */
            --sidebar-bg: #111827; /* Gray 900 */
            --text-primary: #E2E8F0; /* Slate 200 */
            --text-secondary: #94A3B8; /* Slate 400 */
            --text-muted-custom: #64748B; /* Slate 500 - Improved visibility for muted text */
            --accent-color: #FACC15; /* Yellow 500 */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6; /* Blue 500 */
            --border-color: #334155; /* Slate 700 */
            --success-color: #10B981; /* Emerald 500 */
            --danger-color: #EF4444; /* Red 500 */
            --warning-color: #F59E0B; /* Amber 500 */
            --info-color: #60A5FA; /* Blue 400 */
            --link-color: #9CA3AF; /* Gray 400 */
            --link-hover-color: #E5E7EB; /* Gray 200 */
            --placeholder-bg: rgba(100, 116, 139, 0.15); /* Slate 500 with opacity */
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: 'Poppins', sans-serif; padding-top: 60px; }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1030; border-bottom: 1px solid var(--border-color);}
        .header-left { display: flex; align-items: center; gap: 10px;}
        .menu-toggle-btn { background: none; border: none; color: var(--text-primary); font-size: 1.5rem; padding: 0 5px; margin-left: -5px;}
        .header-logo { width: 35px; height: 35px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--accent-color);}
        .header-title { font-size: 1rem; font-weight: 600; line-height: 1.2;}
        .header-right { display: flex; align-items: center; gap: 15px;}
        .admin-email-header { font-size: 0.8rem; color: var(--text-secondary); display: none; }
        @media (min-width: 576px) { .admin-email-header { display: inline; } }
        .offcanvas-start { background-color: var(--sidebar-bg); color: var(--link-color); width: 260px !important; border-right: 1px solid var(--border-color);}
        .offcanvas-header { border-bottom: 1px solid var(--border-color); padding: 1rem 1.2rem;}
        .offcanvas-title h5 { color: var(--text-primary); margin-bottom: 0; font-size: 1.1rem; }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%);}
        .offcanvas-body { padding: 0; display: flex; flex-direction: column; height: calc(100% - 56px); }
        .offcanvas-body .nav { flex-grow: 1; overflow-y: auto; }
        .offcanvas-body .nav-link { color: var(--link-color); padding: 0.8rem 1.2rem; border-left: 3px solid transparent; font-size: 0.95rem;}
        .offcanvas-body .nav-link.active, .offcanvas-body .nav-link:hover { color: var(--link-hover-color); background-color: rgba(255, 255, 255, 0.05); border-left-color: var(--accent-color);}
        .offcanvas-body .nav-link i { margin-right: 12px; width: 20px; text-align: center; font-size: 1.1rem;}
        .offcanvas-logout-btn { margin: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;}
        .main-content { padding: 20px; }
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 20px; }
        .login-container { max-width: 400px; margin: 10vh auto; background-color: var(--secondary-bg); padding: 2rem; border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        #adminLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .spinner-border { color: var(--accent-color); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); margin-bottom: 1.5rem; }
        .card-title { color: var(--text-primary); }
        .table-responsive { overflow-x: auto; }
        .table { background-color: var(--card-bg); color: var(--text-primary); border-color: var(--border-color); margin-bottom: 0;}
        .table > :not(caption) > * > * { background-color: transparent !important; border-bottom-color: var(--border-color); }
        .table th { color: var(--text-secondary); font-weight: 500; white-space: nowrap; padding: 0.8rem 1rem;}
        .table td { vertical-align: middle; white-space: nowrap; padding: 0.7rem 1rem;}
        /* --- Improved Visibility for Muted Text in Tables --- */
        .table td .text-muted { color: var(--text-muted-custom) !important; }
        .table td small.text-muted { font-size: 0.85em; } /* Ensure small muted text is readable */
        .table-hover > tbody > tr:hover > * { background-color: rgba(255, 255, 255, 0.03) !important; color: var(--text-primary); } /* Subtle hover */
        .action-buttons button, .action-buttons a { margin-right: 5px; margin-bottom: 5px; }
        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .modal-header { border-bottom-color: var(--border-color); }
        .modal-footer { border-top-color: var(--border-color); }
        .modal-body label { margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-control, .form-select { background-color: var(--primary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--primary-bg); color: var(--text-primary); border-color: var(--accent-color); box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25); }
        .form-control::placeholder { color: var(--text-secondary); opacity: 0.7; }
        .form-control:disabled, .form-select:disabled { background-color: #2d3748; opacity: 0.7; } /* Disabled state */
        .form-control[type="file"] { background-color: var(--primary-bg); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .form-control[type="color"] { min-height: 38px; padding: 0.2rem; }
        .imgbb-upload-status { display: none; margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);}
        .table img.preview-img { max-width: 60px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); }
        .text-bg-primary { background-color: #3B82F6 !important; }
        .text-bg-info { background-color: #0ea5e9 !important; }
        .text-bg-warning { background-color: #f59e0b !important; }
        .text-bg-success { background-color: #10b981 !important; }
        .text-bg-danger { background-color: #ef4444 !important; }
        .text-bg-secondary { background-color: #6b7280 !important; } /* Gray 500 */
        .text-bg-dark { background-color: #374151 !important; } /* Gray 700 - For Rejected Withdrawals */
        .nav-tabs .nav-link { color: var(--text-secondary); border-color: var(--border-color); border-bottom-color: transparent; margin-bottom: -1px;}
        .nav-tabs .nav-link.active { color: var(--accent-color); background-color: var(--card-bg); border-color: var(--border-color); border-bottom-color: var(--card-bg); font-weight: 600; }
        .nav-tabs { border-bottom-color: var(--border-color); }
        textarea.form-control { min-height: 120px; }
        .copy-btn { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .copy-btn:hover { opacity: 1; }
        .status-badge { font-size: 0.8em; padding: 0.3em 0.6em; border-radius: 0.25rem; }
        .loading-placeholder td > div { background-color: var(--placeholder-bg); border-radius: 4px; min-height: 1.2em; animation: placeholder-glow 2s ease-in-out infinite; }
        @keyframes placeholder-glow { 0% { background-color: var(--placeholder-bg); } 50% { background-color: rgba(100, 116, 139, 0.2); } 100% { background-color: var(--placeholder-bg); } }
        /* Dashboard card icons */
        .dash-card-icon { font-size: 1.8rem; opacity: 0.6; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); }
        .card-body { position: relative; } /* Needed for absolute positioning of icon */
        .color-picker-group { display: flex; align-items: center; gap: 10px; }
        .color-picker-group label { flex-shrink: 0; width: 140px; }
        .color-picker-group .form-control[type="color"] { width: 50px; flex-shrink: 0; }
        .color-picker-group .form-control[type="text"] { flex-grow: 1; }
    </style>
</head>
<body>

    <div id="adminLoader">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <!-- Login / Setup Area -->
    <div id="auth-container">
        <div id="admin-setup-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Account Setup</h2> <p class="text-muted text-center small mb-3">Create the primary admin account.</p> <form id="adminSetupForm"> <div class="mb-3"> <label for="setupEmail" class="form-label">Admin Email</label> <input type="email" class="form-control" id="setupEmail" required> </div> <div class="mb-3"> <label for="setupPassword" class="form-label">Admin Password (min 6 chars)</label> <input type="password" class="form-control" id="setupPassword" required minlength="6"> </div> <div id="adminSetupStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-success">Create Admin Account</button> </div> </form> </div> </div> </div>
        </div>
        <div id="admin-login-section" style="display: none;">
            <div class="container login-container"> <div class="card shadow"> <div class="card-body p-4"> <h2 class="card-title text-center mb-4">Admin Login</h2> <form id="adminLoginForm"> <div class="mb-3"> <label for="adminEmail" class="form-label">Email</label> <input type="email" class="form-control" id="adminEmail" required> </div> <div class="mb-3"> <label for="adminPassword" class="form-label">Password</label> <input type="password" class="form-control" id="adminPassword" required> </div> <div id="adminLoginStatus" class="mt-3"></div> <div class="d-grid"> <button type="submit" class="btn btn-primary">Login</button> </div> </form> </div> </div> </div>
        </div>
    </div>

    <!-- Main Admin Panel Area -->
    <div id="admin-main-area" style="display: none;">
        <header class="app-header">
            <div class="header-left">
                <button class="menu-toggle-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar" aria-controls="adminSidebar">
                    <i class="bi bi-list"></i>
                </button>
                <img src="https://via.placeholder.com/35/1E293B/94A3B8?text=L" alt="Logo" class="header-logo" id="adminHeaderLogo" style="display:none;">
                <h1 class="header-title ms-1" id="adminPageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="admin-email-header" id="adminUserEmailShort"></span>
                <button class="btn btn-sm btn-outline-danger" id="adminLogoutBtnHeader"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </header>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar" aria-labelledby="adminSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="adminSidebarLabel">Admin Menu</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                     <li class="nav-item"> <a class="nav-link active" href="#" data-section="dashboard-section"><i class="bi bi-speedometer2"></i> Dashboard</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="games-section"><i class="bi bi-controller"></i> Games</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="promotions-section"><i class="bi bi-images"></i> Promotions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="tournaments-section"><i class="bi bi-trophy"></i> Tournaments</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="users-section"><i class="bi bi-people"></i> Users</a> </li>
                     <li class="nav-item"> <a class="nav-link" href="#" data-section="transactions-section"><i class="bi bi-receipt"></i> Transactions</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="withdrawals-section"><i class="bi bi-cash-coin"></i> Withdrawals <span class="badge bg-danger ms-1" id="pendingWithdrawalCountBadge" style="display: none;">0</span></a> </li>
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="settings-section"><i class="bi bi-gear"></i> Settings</a> </li>
                    <!-- NEW THEME LINK -->
                    <li class="nav-item"> <a class="nav-link" href="#" data-section="theme-section"><i class="bi bi-palette-fill"></i> Theme</a> </li>
                </ul>
                <div class="mt-auto p-3 border-top border-secondary">
                     <button class="btn btn-warning btn-sm w-100 mb-2" id="addDemoDataBtn"><i class="bi bi-database-add"></i> Add Demo Data</button>
                     <small class="text-muted d-block text-center">Adds sample data if DB is empty.</small>
                </div>
            </div>
        </div>

        <main class="main-content" id="adminMainContent">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="section active">
                <h2>Dashboard Overview</h2>
                <div class="row">
                    <!-- Row 1 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-primary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Users</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalUsers">--</p>
                                <i class="bi bi-people-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-info shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Active/Upcoming Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statActiveTournaments">--</p>
                                <i class="bi bi-trophy-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-warning shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Pending Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statPendingWithdrawals">--</p>
                                <i class="bi bi-hourglass-split dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-success shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Completed Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statCompletedWithdrawals">--</p>
                                <i class="bi bi-check-circle-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Row 2 -->
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-dark shadow-sm h-100"> <!-- Changed color -->
                            <div class="card-body">
                                <h5 class="card-title">Rejected Withdrawals</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statRejectedWithdrawals">--</p>
                                <i class="bi bi-x-octagon-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Games</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalGames">--</p>
                                <i class="bi bi-controller dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Total Promotions</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statTotalPromotions">--</p>
                                <i class="bi bi-images dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-bg-secondary shadow-sm h-100">
                            <div class="card-body">
                                <h5 class="card-title">Finished Tournaments</h5>
                                <p class="card-text fs-3 fw-bold mb-0" id="statFinishedTournaments">--</p>
                                <i class="bi bi-flag-fill dash-card-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="dashboardStatus"></div> <!-- For general dashboard status messages -->
            </section>

            <!-- Games Section -->
            <section id="games-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Games</h2>
                    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#gameModal" id="addNewGameBtn"><i class="bi bi-plus-circle"></i> Add Game</button>
                </div>
                 <div id="gamesStatus" class="mb-3"></div> <!-- Status for actions etc. -->
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead> <tr><th>Image</th><th>Name</th><th>Game ID</th><th>Actions</th></tr> </thead>
                        <tbody id="gamesTableBody"> <!-- Placeholder Rows -->
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="4"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Promotions Section -->
            <section id="promotions-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Promotions</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#promotionModal" id="addNewPromotionBtn"><i class="bi bi-plus-circle"></i> Add Promotion</button>
                </div>
                <div id="promotionsStatus" class="mb-3"></div> <!-- Status for actions etc. -->
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Image</th><th>Link</th><th>Actions</th></tr> </thead>
                         <tbody id="promotionsTableBody"> <!-- Placeholder Rows -->
                            <tr class="loading-placeholder"><td colspan="3"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                </div>
             </section>

            <!-- Tournaments Section -->
            <section id="tournaments-section" class="section">
                 <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                     <h2>Manage Tournaments</h2>
                     <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addTournamentModal" id="addNewTournamentBtn"><i class="bi bi-plus-circle"></i> Add Tournament</button>
                 </div>
                 <div id="tournamentsStatus" class="mb-3"></div> <!-- Status for actions etc. -->
                 <div class="table-responsive card">
                     <table class="table table-dark table-hover mb-0">
                         <thead> <tr><th>Name</th><th>Game</th><th>Fee</th><th>Prize</th><th>Start Time</th><th>Status</th><th>Players</th><th>Actions</th></tr> </thead>
                         <tbody id="tournamentsTableBody"> <!-- Placeholder Rows -->
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="8"><div class="placeholder w-100 py-3"></div></td></tr>
                         </tbody>
                    </table>
                 </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h2>Manage Users</h2>
                    <div class="d-flex gap-2">
                        <input type="search" class="form-control form-control-sm" id="userSearchInput" placeholder="Search by name or email...">
                        <button class="btn btn-success btn-sm flex-shrink-0" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus-fill"></i> Add User
                        </button>
                    </div>
                </div>
                 <div id="usersStatus" class="mb-3"></div> <!-- Status area -->
                <div class="table-responsive card">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr><th>UID</th><th>Display Name</th><th>Email</th><th>Balance</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody id="usersTableBody"> <!-- Placeholder Rows -->
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                            <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions-section" class="section card"> <div class="card-body"> <h2 class="card-title">User Transactions</h2> <p class="text-muted">Section under development.</p></div> </section>

            <!-- Withdrawals Section -->
            <section id="withdrawals-section" class="section">
                <h2>Manage Withdrawals</h2>
                 <div id="withdrawalsStatus" class="mb-3"></div> <!-- Status area -->
                <div class="card">
                    <div class="card-header bg-secondary border-bottom border-dark"> <ul class="nav nav-tabs card-header-tabs" id="withdrawalTabs" role="tablist"> <li class="nav-item" role="presentation"><button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pendingWithdrawalsTab" type="button" role="tab">Pending</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completedWithdrawalsTab" type="button" role="tab">Completed</button></li> <li class="nav-item" role="presentation"><button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejectedWithdrawalsTab" type="button" role="tab">Rejected</button></li> </ul> </div>
                    <div class="card-body tab-content p-0">
                        <div class="tab-pane fade show active" id="pendingWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>User</th><th>Amount</th><th>Method</th><th>Actions</th></tr></thead>
                                    <tbody id="pendingWithdrawalsTableBody"> <!-- Placeholder Rows --> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> <tr class="loading-placeholder"><td colspan="5"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="completedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Admin Note</th></tr></thead>
                                    <tbody id="completedWithdrawalsTableBody"> <!-- Placeholder Rows --> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr> </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="rejectedWithdrawalsTab" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover mb-0">
                                    <thead><tr><th>Requested At</th><th>Processed At</th><th>User</th><th>Amount</th><th>Method</th><th>Reason</th></tr></thead>
                                    <tbody id="rejectedWithdrawalsTableBody"> <!-- Placeholder Rows --> <tr class="loading-placeholder"><td colspan="6"><div class="placeholder w-100 py-3"></div></td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                 </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="section card"> <div class="card-body"> <h2 class="card-title">App Settings</h2> <form id="appSettingsForm"> <div class="row"> <div class="col-md-6 mb-3"> <label for="settingLogoUrl" class="form-label">Logo URL</label> <input type="url" class="form-control" id="settingLogoUrl"> </div> <div class="col-md-6 mb-3"> <label for="settingAppName" class="form-label">App Name</label> <input type="text" class="form-control" id="settingAppName"> </div> <div class="col-md-6 mb-3"> <label for="settingMinWithdraw" class="form-label">Min Withdraw (₹)</label> <input type="number" class="form-control" id="settingMinWithdraw" min="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="settingReferralBonus" class="form-label">Referral Bonus (₹)</label> <input type="number" class="form-control" id="settingReferralBonus" min="0" step="any"> </div> <div class="col-12 mb-3"> <label for="settingSupportContact" class="form-label">Admin Support Contact</label> <input type="text" class="form-control" id="settingSupportContact"> </div> <div class="col-12 mb-3"> <label for="settingUpiDetails" class="form-label">UPI Details for Payment</label> <input type="text" class="form-control" id="settingUpiDetails"> </div> <div class="col-12 mb-3"> <label for="settingPolicyPrivacy" class="form-label">Privacy Policy</label> <textarea class="form-control" id="settingPolicyPrivacy" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyTerms" class="form-label">Terms & Conditions</label> <textarea class="form-control" id="settingPolicyTerms" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyRefund" class="form-label">Refund Policy</label> <textarea class="form-control" id="settingPolicyRefund" rows="5"></textarea> </div> <div class="col-12 mb-3"> <label for="settingPolicyFairPlay" class="form-label">Fair Play Policy</label> <textarea class="form-control" id="settingPolicyFairPlay" rows="5"></textarea> </div> </div> <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Save Settings</button> <div id="settingsStatus" class="mt-3"></div> </form> </div> </section>
            
            <!-- ======================= -->
            <!-- NEW: THEME SECTION      -->
            <!-- ======================= -->
            <section id="theme-section" class="section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="section-title mb-0">Theme Customization</h2>
                    <button class="btn btn-danger btn-sm" id="resetThemeBtn"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default Theme</button>
                </div>
                <div id="themeStatus" class="mb-3"></div>

                <div class="row">
                    <!-- Predefined Themes -->
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Predefined Themes</h5>
                                <p class="card-text text-secondary small">Select a theme to preview the colors in the form below, then click "Save Theme" to apply it.</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary" id="previewDefaultThemeBtn">Default Dark</button>
                                    <button class="btn btn-outline-danger" id="previewCrimsonThemeBtn">Crimson Dark</button>
                                    <button class="btn btn-outline-info" id="previewOceanicThemeBtn">Oceanic Blue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Custom Theme Form -->
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Custom Theme Colors</h5>
                                <form id="customThemeForm">
                                    <div class="row g-3">
                                        <!-- Key Colors -->
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-primary-bg" class="form-label">Primary BG</label>
                                                <input type="color" class="form-control form-control-color" id="theme-primary-bg" data-var="--primary-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-primary-bg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-accent-color" class="form-label">Accent Color</label>
                                                <input type="color" class="form-control form-control-color" id="theme-accent-color" data-var="--accent-color">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-accent-color">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-text-primary" class="form-label">Primary Text</label>
                                                <input type="color" class="form-control form-control-color" id="theme-text-primary" data-var="--text-primary">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-text-primary">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-primary-button-bg" class="form-label">Primary Button</label>
                                                <input type="color" class="form-control form-control-color" id="theme-primary-button-bg" data-var="--primary-button-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-primary-button-bg">
                                            </div>
                                        </div>
                                        <div class="col-12"><hr class="my-2"></div>
                                        <!-- Other Colors -->
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-secondary-bg" class="form-label">Secondary BG</label>
                                                <input type="color" class="form-control form-control-color" id="theme-secondary-bg" data-var="--secondary-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-secondary-bg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-card-bg" class="form-label">Card BG</label>
                                                <input type="color" class="form-control form-control-color" id="theme-card-bg" data-var="--card-bg">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-card-bg">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-text-secondary" class="form-label">Secondary Text</label>
                                                <input type="color" class="form-control form-control-color" id="theme-text-secondary" data-var="--text-secondary">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-text-secondary">
                                            </div>
                                        </div>
                                         <div class="col-md-6">
                                            <div class="color-picker-group mb-2">
                                                <label for="theme-border-color" class="form-label">Border Color</label>
                                                <input type="color" class="form-control form-control-color" id="theme-border-color" data-var="--border-color">
                                                <input type="text" class="form-control form-control-sm" data-target="theme-border-color">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-end mt-4">
                                         <button type="button" class="btn btn-primary" id="saveThemeBtn"><i class="bi bi-save"></i> Save Theme</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Game Modal -->
    <div class="modal fade" id="gameModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="gameModalTitle">Add New Game</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="gameForm"> <input type="hidden" id="gameEditId"> <div class="mb-3"> <label for="gameName" class="form-label">Game Name</label> <input type="text" class="form-control" id="gameName" required> </div> <div class="mb-3"> <label for="gameImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="gameImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="gameImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="gameImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div id="gameStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveGameBtn">Save Game</button> </div> </div> </div> </div>
    <!-- Add/Edit Promotion Modal -->
    <div class="modal fade" id="promotionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="promotionModalTitle">Add New Promotion</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="promotionForm"> <input type="hidden" id="promotionEditId"> <div class="mb-3"> <label for="promoImageUrl" class="form-label">Image URL</label> <input type="url" class="form-control" id="promoImageUrl" required> <small class="text-muted">Direct image URL (e.g., from ImgBB).</small> </div> <div class="mb-3"> <label for="promoImageFile" class="form-label">Upload New Image (Optional - Overwrites URL)</label> <input class="form-control" type="file" id="promoImageFile" accept="image/*"> <div class="imgbb-upload-status mt-2"></div> </div> <div class="mb-3"> <label for="promoLink" class="form-label">Link (Optional)</label> <input type="url" class="form-control" id="promoLink"> </div> <div id="promotionStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="savePromotionBtn">Save Promotion</button> </div> </div> </div> </div>
    <!-- Add/Edit Tournament Modal -->
    <div class="modal fade" id="addTournamentModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="tournamentModalTitle">Add New Tournament</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <form id="tournamentForm"> <input type="hidden" id="tournamentEditId"> <div class="row"> <div class="col-md-6 mb-3"> <label for="tournamentGame" class="form-label">Game</label> <select class="form-select" id="tournamentGame" required></select> </div> <div class="col-md-6 mb-3"> <label for="tournamentName" class="form-label">Tournament Name</label> <input type="text" class="form-control" id="tournamentName" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStartTime" class="form-label">Start Date & Time</label> <input type="datetime-local" class="form-control" id="tournamentStartTime" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentStatus" class="form-label">Status</label> <select class="form-select" id="tournamentStatus" required> <option value="upcoming">Upcoming</option> <option value="ongoing">Ongoing</option> <option value="completed">Completed</option> <option value="result">Result</option> <option value="cancelled">Cancelled</option> </select> </div> <div class="col-md-4 mb-3"> <label for="tournamentEntryFee" class="form-label">Entry Fee (₹)</label> <input type="number" class="form-control" id="tournamentEntryFee" min="0" value="0" required step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPrizePool" class="form-label">Total Prize Pool (₹)</label> <input type="number" class="form-control" id="tournamentPrizePool" min="0" value="0" step="any"> </div> <div class="col-md-4 mb-3"> <label for="tournamentPerKill" class="form-label">Per Kill Prize (₹)</label> <input type="number" class="form-control" id="tournamentPerKill" min="0" value="0" step="any"> </div> <div class="col-md-6 mb-3"> <label for="tournamentMaxPlayers" class="form-label">Max Players (0 for Unlimited)</label> <input type="number" class="form-control" id="tournamentMaxPlayers" min="0" value="0" required> </div> <div class="col-md-6 mb-3"> <label for="tournamentTags" class="form-label">Tags (comma-separated)</label> <input type="text" class="form-control" id="tournamentTags" placeholder="e.g., Solo, Erangel, TPP"> </div> <div class="col-12 mb-3"> <label for="tournamentDescription" class="form-label">Description / Rules</label> <textarea class="form-control" id="tournamentDescription" rows="4"></textarea> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomId" class="form-label">Room ID</label> <input type="text" class="form-control" id="tournamentRoomId"> </div> <div class="col-md-6 mb-3"> <label for="tournamentRoomPassword" class="form-label">Room Password</label> <input type="text" class="form-control" id="tournamentRoomPassword"> </div> <div class="form-check mb-3 ms-2"> <input class="form-check-input" type="checkbox" id="tournamentShowIdPass"> <label class="form-check-label" for="tournamentShowIdPass"> Show ID/Pass?</label> </div> </div> <div id="addTournamentStatus" class="mt-2"></div></form> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <button type="button" class="btn btn-primary" id="saveTournamentBtn">Save Tournament</button> </div> </div> </div> </div>
    <!-- View/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1"> <div class="modal-dialog modal-lg"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title" id="userModalTitle">User Details</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <div class="row"> <div class="col-md-6"> <h5>User Info</h5> <p><strong>UID:</strong> <small id="userDetailUid" class="text-muted user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailUid" title="Copy UID"></i></p> <p><strong>Email:</strong> <span id="userDetailEmail"></span></p> <p><strong>Name:</strong> <span id="userDetailName"></span></p> <p><strong>Created At:</strong> <span id="userDetailCreatedAt">N/A</span></p> <hr> <h5>Wallet</h5> <p>Total Balance: ₹<span id="userDetailBalance">0.00</span></p> <p>Winning Cash: ₹<span id="userDetailWinning">0.00</span></p> <p>Bonus Cash: ₹<span id="userDetailBonus">0.00</span></p> <hr> <h5>Referral Info</h5> <p><strong>Referral Code:</strong> <span id="userDetailReferralCode" class="text-info">N/A</span> <i class="bi bi-clipboard copy-btn ms-1" data-target="#userDetailReferralCode" title="Copy Code"></i></p> <p><strong>Referred By:</strong> <span id="userDetailReferredBy">N/A</span></p> <p><strong>Users Referred:</strong> <span id="userDetailReferredCount">N/A</span></p> </div> <div class="col-md-6"> <h5>Update Balance (Caution!)</h5> <form id="updateBalanceForm"> <input type="hidden" id="editUserUid"> <div class="row"> <div class="col-md-6 mb-3"> <label for="balanceUpdateAmount" class="form-label">Amount (+/-)</label> <input type="number" step="any" class="form-control" id="balanceUpdateAmount" placeholder="e.g., 50 or -20" required> </div> <div class="col-md-6 mb-3"> <label for="balanceUpdateType" class="form-label">Balance Type</label> <select id="balanceUpdateType" class="form-select" required> <option value="">--Select--</option> <option value="balance">Total Balance</option> <option value="winningCash">Winning Cash</option> <option value="bonusCash">Bonus Cash</option> </select> </div> </div> <div class="mb-3"> <label for="balanceUpdateReason" class="form-label">Reason</label> <input type="text" class="form-control" id="balanceUpdateReason" placeholder="Manual Deposit, Correction etc." required> </div> <button type="submit" class="btn btn-warning">Update Balance</button> <div id="balanceUpdateStatus" class="mt-2"></div> </form> <hr> <h5>Status & Actions</h5> <p>Current Status: <span id="userDetailStatus" class="fw-bold"></span></p> <button class="btn btn-sm mb-2" id="userBlockBtn"></button> <button class="btn btn-sm btn-danger mb-2" id="userDeleteBtn"><i class="bi bi-trash"></i> Delete User (DB Only)</button> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> </div> </div> </div> </div>
    <!-- Withdrawal Action Modal -->
    <div class="modal fade" id="withdrawalActionModal" tabindex="-1"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title">Withdrawal Action</h5> <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button> </div> <div class="modal-body"> <p><strong>Request ID:</strong> <small id="withdrawalDetailId" class="text-muted withdrawal-id-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailId" title="Copy Request ID"></i></p> <p><strong>User:</strong> <span id="withdrawalDetailUser"></span> (<small id="withdrawalDetailUserUid" class="text-muted withdrawal-user-uid-copy"></small> <i class="bi bi-clipboard copy-btn ms-1" data-target="#withdrawalDetailUserUid" title="Copy User UID"></i>)</p> <p><strong>Amount:</strong> ₹<span id="withdrawalDetailAmount"></span></p> <p><strong>Method:</strong> <span id="withdrawalDetailMethod"></span></p> <hr> <div id="withdrawalRejectReasonDiv" style="display: none;" class="mb-3"> <label for="withdrawalRejectReason" class="form-label">Reason for Rejection</label> <textarea class="form-control" id="withdrawalRejectReason" rows="3" required></textarea> </div> <div id="withdrawalApproveNoteDiv" style="display: none;" class="mb-3"> <label for="withdrawalApproveNote" class="form-label">Admin Note / Txn ID (Optional)</label> <input type="text" class="form-control" id="withdrawalApproveNote" placeholder="e.g., Transaction ID"> </div> <div id="withdrawalActionStatus" class="mt-2"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button> <button type="button" class="btn btn-danger" id="rejectWithdrawalBtn">Reject</button> <button type="button" class="btn btn-success" id="approveWithdrawalBtn">Approve</button> </div> </div> </div> </div>
    <!-- Add New User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUserName" class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="newUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserEmail" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="newUserEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password (min 6 chars)</label>
                            <input type="password" class="form-control" id="newUserPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="newUserInitialBalance" class="form-label">Initial Balance (₹)</label>
                            <input type="number" step="any" class="form-control" id="newUserInitialBalance" value="0" min="0">
                            <small class="text-muted">This will be added to Total Balance.</small>
                        </div>
                        <div id="addUserStatus" class="mt-2"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNewUserBtn">Create User</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Registered Players Modal -->
    <div class="modal fade" id="registeredPlayersModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registeredPlayersModalTitle">Registered Players</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tournament: <strong id="registeredPlayersTournamentName"></strong></p>
                    <div id="registeredPlayersStatus" class="mb-2"></div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm table-hover">
                            <thead>
                                <tr><th>User UID</th><th>Name</th><th>Email</th><th>Joined At</th></tr>
                            </thead>
                            <tbody id="registeredPlayersTableBody">
                                <tr><td colspan="4" class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, off, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // ===============================================================
        // ================= !!! IMPORTANT !!! ===========================
        // Replace the placeholder values below with your actual Firebase project configuration.
        // You can find these details in your Firebase project settings:
        // Project settings > General > Your apps > Web app > SDK setup and configuration > Config
        // ===============================================================
        const firebaseConfig = {
  apiKey: "AIzaSyCSUorduB230BvoTZsze0awqoLuktXNjYE",
  authDomain: "zx-e-sports-team.firebaseapp.com",
  databaseURL: "https://zx-e-sports-team-default-rtdb.firebaseio.com",
  projectId: "zx-e-sports-team",
  storageBucket: "zx-e-sports-team.firebasestorage.app",
  messagingSenderId: "1069049520103",
  appId: "1:1069049520103:web:a09ce1f56bec4026056742",
  measurementId: "G-BVBNJ7YH33"
};
        // ===============================================================
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            // Check if placeholder values are still present
             if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.warn("Admin Panel: Firebase config using placeholder values. Replace them with your actual project details.");
                // Optionally prevent initialization or show a UI warning here
                // For this example, we'll allow initialization but log the warning.
             }
             app = initializeApp(firebaseConfig);
             db = getDatabase(app);
             auth = getAuth(app);
             console.log("Admin Panel: Firebase Initialized (check config if using placeholders)");
        } catch (error) {
             console.error("Admin Panel: Firebase initialization failed:", error);
             document.body.innerHTML = `<div class="alert alert-danger m-5"><strong>Critical Error:</strong> Could not connect to Firebase services. Check console, config, and network. Error: ${error.message}</div>`;
        }

        // DOM Elements Cache (Added new elements for dashboard and modals)
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        const elements = {
             adminLoader: getElement('adminLoader'),
             authContainer: getElement('auth-container'),
             loginSection: getElement('admin-login-section'),
             setupSection: getElement('admin-setup-section'),
             mainArea: getElement('admin-main-area'),
             adminLoginForm: getElement('adminLoginForm'),
             adminEmailInput: getElement('adminEmail'),
             adminPasswordInput: getElement('adminPassword'),
             adminLoginStatus: getElement('adminLoginStatus'),
             adminSetupForm: getElement('adminSetupForm'),
             setupEmailInput: getElement('setupEmail'),
             setupPasswordInput: getElement('setupPassword'),
             setupStatus: getElement('adminSetupStatus'),
             adminUserEmailDisplay: getElement('adminUserEmailShort'),
             adminLogoutBtn: getElement('adminLogoutBtnHeader'),
             sidebar: getElement('adminSidebar'),
             sidebarLinks: querySelAll('#adminSidebar .nav-link'),
             sections: querySelAll('#adminMainContent .section'),
             adminPageTitle: getElement('adminPageTitle'),
             adminHeaderLogo: getElement('adminHeaderLogo'),
             // Dashboard (Expanded)
             dashboardSection: getElement('dashboard-section'),
             statTotalUsers: getElement('statTotalUsers'),
             statActiveTournaments: getElement('statActiveTournaments'),
             statPendingWithdrawals: getElement('statPendingWithdrawals'),
             statCompletedWithdrawals: getElement('statCompletedWithdrawals'), // New
             statRejectedWithdrawals: getElement('statRejectedWithdrawals'),   // New
             statTotalGames: getElement('statTotalGames'),                   // New
             statTotalPromotions: getElement('statTotalPromotions'),         // New
             statFinishedTournaments: getElement('statFinishedTournaments'), // New
             dashboardStatus: getElement('dashboardStatus'),
             pendingWithdrawalCountBadge: getElement('pendingWithdrawalCountBadge'),
             // Games (Modal elements consolidated)
             gamesTableBody: getElement('gamesTableBody'),
             gameModalEl: getElement('gameModal'), // Renamed modal ID
             gameModalTitle: getElement('gameModalTitle'),
             gameForm: getElement('gameForm'),
             gameEditId: getElement('gameEditId'),
             gameNameInput: getElement('gameName'),
             gameImageFileInput: getElement('gameImageFile'),
             gameImageUrlInput: getElement('gameImageUrl'),
             saveGameBtn: getElement('saveGameBtn'),
             gameStatus: getElement('gameStatus'), // Status within modal
             gamesStatus: getElement('gamesStatus'), // Status in section
             addNewGameBtn: getElement('addNewGameBtn'),
             // Promotions (Modal elements consolidated)
             promotionsTableBody: getElement('promotionsTableBody'),
             promotionModalEl: getElement('promotionModal'), // Renamed modal ID
             promotionModalTitle: getElement('promotionModalTitle'),
             promotionForm: getElement('promotionForm'),
             promotionEditId: getElement('promotionEditId'),
             promoImageFileInput: getElement('promoImageFile'),
             promoImageUrlInput: getElement('promoImageUrl'),
             promoLinkInput: getElement('promoLink'),
             savePromotionBtn: getElement('savePromotionBtn'),
             promotionStatus: getElement('promotionStatus'), // Status within modal
             promotionsStatus: getElement('promotionsStatus'), // Status in section
             addNewPromotionBtn: getElement('addNewPromotionBtn'),
             // Tournaments
             tournamentsTableBody: getElement('tournamentsTableBody'),
             addTournamentModalEl: getElement('addTournamentModal'),
             tournamentForm: getElement('tournamentForm'),
             tournamentModalTitle: getElement('tournamentModalTitle'),
             tournamentEditId: getElement('tournamentEditId'),
             tournamentGameSelect: getElement('tournamentGame'),
             tournamentNameInput: getElement('tournamentName'),
             tournamentStartTimeInput: getElement('tournamentStartTime'),
             tournamentStatusSelect: getElement('tournamentStatus'),
             tournamentEntryFeeInput: getElement('tournamentEntryFee'),
             tournamentPrizePoolInput: getElement('tournamentPrizePool'),
             tournamentPerKillInput: getElement('tournamentPerKill'),
             tournamentMaxPlayersInput: getElement('tournamentMaxPlayers'),
             tournamentTagsInput: getElement('tournamentTags'),
             tournamentDescriptionInput: getElement('tournamentDescription'),
             tournamentRoomIdInput: getElement('tournamentRoomId'),
             tournamentRoomPasswordInput: getElement('tournamentRoomPassword'),
             tournamentShowIdPassCheckbox: getElement('tournamentShowIdPass'),
             saveTournamentBtn: getElement('saveTournamentBtn'),
             addNewTournamentBtn: getElement('addNewTournamentBtn'),
             addTournamentStatus: getElement('addTournamentStatus'),
             tournamentsStatus: getElement('tournamentsStatus'),
             // Users
             usersSection: getElement('users-section'),
             usersTableBody: getElement('usersTableBody'),
             userSearchInput: getElement('userSearchInput'),
             userModalEl: getElement('userModal'),
             userModalTitle: getElement('userModalTitle'),
             userDetailUid: getElement('userDetailUid'),
             userDetailEmail: getElement('userDetailEmail'),
             userDetailName: getElement('userDetailName'),
             userDetailCreatedAt: getElement('userDetailCreatedAt'),
             userDetailBalance: getElement('userDetailBalance'),
             userDetailWinning: getElement('userDetailWinning'),
             userDetailBonus: getElement('userDetailBonus'),
             userDetailReferralCode: getElement('userDetailReferralCode'),
             userDetailReferredBy: getElement('userDetailReferredBy'),
             userDetailReferredCount: getElement('userDetailReferredCount'),
             userDetailStatus: getElement('userDetailStatus'),
             updateBalanceForm: getElement('updateBalanceForm'),
             editUserUid: getElement('editUserUid'),
             balanceUpdateAmountInput: getElement('balanceUpdateAmount'),
             balanceUpdateTypeSelect: getElement('balanceUpdateType'),
             balanceUpdateReasonInput: getElement('balanceUpdateReason'),
             balanceUpdateStatus: getElement('balanceUpdateStatus'),
             userBlockBtn: getElement('userBlockBtn'),
             userDeleteBtn: getElement('userDeleteBtn'),
             addUserModalEl: getElement('addUserModal'),
             addUserForm: getElement('addUserForm'),
             newUserNameInput: getElement('newUserName'),
             newUserEmailInput: getElement('newUserEmail'),
             newUserPasswordInput: getElement('newUserPassword'),
             newUserInitialBalanceInput: getElement('newUserInitialBalance'),
             saveNewUserBtn: getElement('saveNewUserBtn'),
             addUserStatus: getElement('addUserStatus'),
             usersStatus: getElement('usersStatus'),
             // Withdrawals
             pendingWithdrawalsTableBody: getElement('pendingWithdrawalsTableBody'),
             completedWithdrawalsTableBody: getElement('completedWithdrawalsTableBody'),
             rejectedWithdrawalsTableBody: getElement('rejectedWithdrawalsTableBody'),
             withdrawalActionModalEl: getElement('withdrawalActionModal'),
             withdrawalDetailId: getElement('withdrawalDetailId'),
             withdrawalDetailUser: getElement('withdrawalDetailUser'),
             withdrawalDetailUserUid: getElement('withdrawalDetailUserUid'),
             withdrawalDetailAmount: getElement('withdrawalDetailAmount'),
             withdrawalDetailMethod: getElement('withdrawalDetailMethod'),
             withdrawalRejectReasonDiv: getElement('withdrawalRejectReasonDiv'),
             withdrawalRejectReasonInput: getElement('withdrawalRejectReason'),
             withdrawalApproveNoteDiv: getElement('withdrawalApproveNoteDiv'),
             withdrawalApproveNoteInput: getElement('withdrawalApproveNote'),
             withdrawalActionStatus: getElement('withdrawalActionStatus'),
             rejectWithdrawalBtn: getElement('rejectWithdrawalBtn'),
             approveWithdrawalBtn: getElement('approveWithdrawalBtn'),
             withdrawalsStatus: getElement('withdrawalsStatus'),
             // Registered Players Modal
             registeredPlayersModalEl: getElement('registeredPlayersModal'),
             registeredPlayersModalTitle: getElement('registeredPlayersModalTitle'),
             registeredPlayersTournamentName: getElement('registeredPlayersTournamentName'),
             registeredPlayersTableBody: getElement('registeredPlayersTableBody'),
             registeredPlayersStatus: getElement('registeredPlayersStatus'),
             // Settings
             settingsSection: getElement('settings-section'),
             appSettingsForm: getElement('appSettingsForm'),
             settingLogoUrlInput: getElement('settingLogoUrl'),
             settingAppNameInput: getElement('settingAppName'),
             settingMinWithdrawInput: getElement('settingMinWithdraw'),
             settingReferralBonusInput: getElement('settingReferralBonus'),
             settingSupportContactInput: getElement('settingSupportContact'),
             settingUpiDetailsInput: getElement('settingUpiDetails'),
             settingPolicyPrivacyInput: getElement('settingPolicyPrivacy'),
             settingPolicyTermsInput: getElement('settingPolicyTerms'),
             settingPolicyRefundInput: getElement('settingPolicyRefund'),
             settingPolicyFairPlayInput: getElement('settingPolicyFairPlay'),
             settingsStatus: getElement('settingsStatus'),
            // NEW THEME ELEMENTS
            themeSection: getElement('theme-section'),
            themeStatus: getElement('themeStatus'),
            customThemeForm: getElement('customThemeForm'),
            themeColorPickers: querySelAll('#customThemeForm input[type="color"]'),
            saveThemeBtn: getElement('saveThemeBtn'),
            resetThemeBtn: getElement('resetThemeBtn'),
            previewDefaultThemeBtn: getElement('previewDefaultThemeBtn'),
            previewCrimsonThemeBtn: getElement('previewCrimsonThemeBtn'),
            previewOceanicThemeBtn: getElement('previewOceanicThemeBtn'),
             // Demo Data
             addDemoDataBtn: getElement('addDemoDataBtn'),
             // Transactions
             transactionsSection: getElement('transactions-section')
        };

        // Bootstrap Modal/Offcanvas Instances Cache
        let componentInstances = {}; // Combined cache
        const getComponentInstance = (element, componentType = 'Modal') => {
            if (!element) return null;
            const instanceKey = `${componentType}-${element.id}`;
            if (!componentInstances[instanceKey]) {
                try {
                     if (componentType === 'Modal') componentInstances[instanceKey] = new bootstrap.Modal(element);
                     else if (componentType === 'Offcanvas') componentInstances[instanceKey] = new bootstrap.Offcanvas(element);
                     else if (componentType === 'Tab') componentInstances[instanceKey] = new bootstrap.Tab(element);
                     else if (componentType === 'Alert') componentInstances[instanceKey] = new bootstrap.Alert(element);
                     else if (componentType === 'Toast') componentInstances[instanceKey] = new bootstrap.Toast(element);
                     else { console.warn("Unknown Bootstrap component type:", componentType); return null; }
                } catch (e) {
                    console.error(`Error creating Bootstrap ${componentType} instance for #${element.id}:`, e);
                    return null;
                }
            }
            return componentInstances[instanceKey];
        }
        const getModalInstance = (element) => getComponentInstance(element, 'Modal');
        const getOffcanvasInstance = (element) => getComponentInstance(element, 'Offcanvas');

        // --- App State ---
        let currentAdminUser = null;
        let currentWithdrawalAction = { id: null, type: null, userId: null };
        let currentEditingItemId = null; // Generic ID for editing game/promo
        let currentEditingTournamentId = null;
        let gameDataCache = {}; // { gameId: gameName }
        let userDataCache = {}; // { userId: { displayName, email, status, balance, winningCash } }
        let fullUserDataCache = {}; // { userId: fullUserData } - for search/modal
        let dbListeners = {};
        let isAdminSetupComplete = false;
        let designatedAdminUid = null;
        let appSettings = {};

        // =========================================================================
        // --- NEW: THEME DEFINITIONS ---
        // =========================================================================
        const defaultTheme = {
            '--primary-bg': '#0F172A',
            '--secondary-bg': '#1E293B',
            '--card-bg': '#1E293B',
            '--text-primary': '#E2E8F0',
            '--text-secondary': '#94A3B8',
            '--accent-color': '#FACC15',
            '--primary-button-bg': '#3B82F6',
            '--border-color': '#334155',
        };
        const crimsonTheme = {
            '--primary-bg': '#1a0005',
            '--secondary-bg': '#2e0009',
            '--card-bg': '#2e0009',
            '--text-primary': '#fce7f3',
            '--text-secondary': '#e9a8d9',
            '--accent-color': '#f43f5e',
            '--primary-button-bg': '#be185d',
            '--border-color': '#500724',
        };
        const oceanicTheme = {
            '--primary-bg': '#0c1445',
            '--secondary-bg': '#182157',
            '--card-bg': '#182157',
            '--text-primary': '#e0e7ff',
            '--text-secondary': '#a5b4fc',
            '--accent-color': '#38bdf8',
            '--primary-button-bg': '#4338ca',
            '--border-color': '#312e81',
        };
        // =========================================================================


        // --- Admin Auth & Security ---
        function isDesignatedAdmin(user) {
            if (!user) return false;
            if (!designatedAdminUid) {
                 console.warn("Designated Admin UID check failed: UID not loaded yet.");
                 return false;
            }
            return user.uid === designatedAdminUid;
        }

        // --- Utility Functions ---
        const showLoader = (show) => { if (elements.adminLoader) elements.adminLoader.style.display = show ? 'flex' : 'none'; };

        function showStatus(element, message, type = 'danger', autohide = 5000) {
            if (!element) {
                console.warn("showStatus called with null element for message:", message);
                return;
            }
             const alertId = `status-alert-${element.id || Math.random().toString(36).substring(2)}`;
             element.style.display = 'block';
             element.innerHTML = `<div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">${sanitizeHTML(message)}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;

             if (autohide && typeof autohide === 'number' && autohide > 0) {
                setTimeout(() => {
                    const currentAlert = getElement(alertId);
                    if (currentAlert) {
                        try {
                            const bsAlert = getComponentInstance(currentAlert, 'Alert');
                             if (bsAlert) bsAlert.close();
                             else currentAlert.remove();
                        } catch (e) {
                            console.warn("Error closing alert:", e);
                            currentAlert.remove();
                        }
                    }
                }, autohide);
            }
        }

        function clearStatus(element) {
             if (!element) return;
             element.innerHTML = '';
        }

        const formatDate = (timestamp) => {
            if (!timestamp) return 'N/A';
            if (typeof timestamp === 'object' && timestamp.hasOwnProperty('.sv')) { return 'Pending...'; }
            const tsNumber = Number(timestamp);
            if (isNaN(tsNumber) || tsNumber <= 0) return 'Invalid Date';
            try {
                const date = new Date(tsNumber);
                if (isNaN(date.getTime())) return 'Invalid Date';
                return date.toLocaleString([], { dateStyle: 'short', timeStyle: 'short'});
            } catch (e) { console.warn("Error formatting date:", timestamp, e); return 'Invalid Date'; }
        };

        const formatCurrency = (amount) => {
            const num = Number(amount);
            return isNaN(num) ? '₹--' : `₹${num.toFixed(2)}`;
        }

        function sanitizeHTML(str) {
             if (str == null) return '';
             str = String(str);
             const temp = document.createElement('div');
             temp.textContent = str;
             return temp.innerHTML;
        }

        function copyToClipboard(targetSelector) {
            // Find the target relative to the clicked copy icon's closest relevant parent (modal or table row)
            const copyIcon = event?.target.closest('.copy-btn');
            const context = copyIcon?.closest('.modal-body, tr');
            const element = context?.querySelector(targetSelector);
            const textToCopy = element?.textContent?.trim();

            if (!textToCopy) { console.warn("Copy target empty or not found:", targetSelector); return; }

            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                         const toastEl = document.createElement('div');
                         toastEl.className = 'toast position-fixed bottom-0 end-0 p-3 m-3 text-bg-success border-0';
                         toastEl.setAttribute('role', 'alert'); toastEl.setAttribute('aria-live', 'assertive'); toastEl.setAttribute('aria-atomic', 'true');
                         toastEl.innerHTML = '<div class="toast-body">Copied!</div>';
                         document.body.appendChild(toastEl);
                         const toast = getComponentInstance(toastEl, 'Toast');
                         if(toast) toast.show();
                         toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
                    })
                    .catch(err => { console.warn('Clipboard writeText failed: ', err); alert('Could not copy.'); });
            } else {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px"; textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();
                try { document.execCommand('copy'); alert('Copied! (fallback)'); }
                catch (err) { console.warn('Fallback copy failed: ', err); alert('Copy failed.'); }
                document.body.removeChild(textArea);
            }
        }

        const tableLoadingPlaceholderHtml = (cols) => `<tr class="loading-placeholder"><td colspan="${cols}"><div class="placeholder w-100 py-3"></div></td></tr>`.repeat(3);

        // --- UI Functions ---
        function showAdminSection(sectionId) {
             elements.sections.forEach(sec => sec.classList.remove('active'));
             const targetSection = getElement(sectionId);
             if (targetSection) {
                 targetSection.classList.add('active');
                 const linkElement = querySel(`#adminSidebar .nav-link[data-section="${sectionId}"]`);
                 let title = 'Admin Panel';
                 if (linkElement) {
                     const linkText = linkElement.textContent.trim() || sectionId.replace('-section', '').replace('-', ' ');
                     title = linkText.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                     const badge = linkElement.querySelector('.badge');
                     if (badge) { title = title.replace(badge.textContent, '').trim(); }
                 }

                 if(elements.adminPageTitle) elements.adminPageTitle.textContent = title;
                 elements.sidebarLinks?.forEach(link => { link.classList.toggle('active', link.dataset.section === sectionId); });

                 loadDataForSection(sectionId); // Load data when section becomes active

                 const sidebar = getOffcanvasInstance(elements.sidebar);
                 if (sidebar?._isShown) sidebar.hide();
             } else {
                 console.error("Section element not found:", sectionId);
                 showAdminSection('dashboard-section'); // Fallback
             }
        }

        function loadDataForSection(sectionId) {
             if (!currentAdminUser || !isDesignatedAdmin(currentAdminUser)) {
                 console.warn("Attempted to load data without proper admin authorization.");
                 showStatus(elements.dashboardStatus, "Admin not authorized.", "danger", false);
                 return;
             }
             console.log(`Loading data for section: ${sectionId}`);

             // Clear status areas for all potentially visible sections
             clearStatus(elements.dashboardStatus); clearStatus(elements.gamesStatus); clearStatus(elements.promotionsStatus);
             clearStatus(elements.tournamentsStatus); clearStatus(elements.usersStatus); clearStatus(elements.withdrawalsStatus);
             clearStatus(elements.settingsStatus);
             clearStatus(elements.themeStatus); // Clear theme status

             switch(sectionId) {
                 case 'dashboard-section': loadDashboardStats(); break;
                 case 'games-section': loadGames(); break;
                 case 'promotions-section': loadPromotions(); break;
                 case 'tournaments-section': loadTournaments(); break;
                 case 'users-section': loadUsers(); break;
                 case 'withdrawals-section':
                    loadWithdrawals('pending'); loadWithdrawals('completed'); loadWithdrawals('rejected');
                    // Ensure correct tab is shown (if switching from another section)
                     const activeTabBtn = querySel('#withdrawalTabs .nav-link.active') || getElement('pending-tab');
                     if (activeTabBtn) getComponentInstance(activeTabBtn, 'Tab')?.show();
                    break;
                 case 'settings-section': loadSettings(); break;
                 case 'theme-section': loadThemeSettings(); break; // Load theme data
                 case 'transactions-section':
                     if (elements.transactionsSection) elements.transactionsSection.innerHTML = '<div class="card-body"><h2 class="card-title">User Transactions</h2><p class="text-muted">Section under development.</p></div>';
                     break;
                 default: console.warn("Unknown section requested:", sectionId); showStatus(elements.dashboardStatus, `Unknown section requested: ${sectionId}`, "warning");
             }
         }

        // --- Firebase Auth Functions --- (No change needed)
        async function loginAdmin(event) { event.preventDefault(); if (!auth) return; const email = elements.adminEmailInput.value; const password = elements.adminPasswordInput.value; clearStatus(elements.adminLoginStatus); showLoader(true); try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Admin Login Error:", error); let message = `Login Failed: ${error.code}`; if (error.code === 'auth/network-request-failed') { message = "Login Failed: Network error."; } else if (['auth/invalid-credential', 'auth/wrong-password', 'auth/user-not-found', 'auth/invalid-email'].includes(error.code)) { message = "Login Failed: Invalid email or password."; } else if (error.code === 'auth/too-many-requests') { message = "Login Failed: Too many attempts."; } showStatus(elements.adminLoginStatus, message, 'danger', false); } finally { showLoader(false); } }
        async function logoutAdminUser() { if (!auth) return; showLoader(true); try { await signOut(auth); } catch (error) { console.error("Admin Logout Error:", error); alert("Logout failed: " + error.message); } finally { /* Loader hidden by auth state change */ } }

        // --- Admin Setup & Verification --- (No change needed)
        async function checkAdminSetup() { if (!db) return false; const adminConfigRef = ref(db, 'adminConfig'); try { console.log("Checking admin setup..."); const snapshot = await get(adminConfigRef); if (snapshot.exists()) { const d = snapshot.val(); isAdminSetupComplete = d.setupComplete === true; designatedAdminUid = d.adminUid || null; } else { isAdminSetupComplete = false; designatedAdminUid = null; } console.log("Admin setup check:", isAdminSetupComplete, "| UID:", designatedAdminUid); return isAdminSetupComplete; } catch (error) { console.error("Error checking admin setup:", error); const el = elements.loginSection?.style.display === 'block' ? elements.adminLoginStatus : elements.setupStatus; if (el) showStatus(el, `Config check error: ${error.message}. Check Rules.`, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; return false; } }
        async function setupAdmin(event) { event.preventDefault(); if (!auth || !db || isAdminSetupComplete) return; const email = elements.setupEmailInput.value.trim(); const password = elements.setupPasswordInput.value; clearStatus(elements.setupStatus); if (password.length < 6) { showStatus(elements.setupStatus, "Password min 6 chars.", "warning"); return; } showLoader(true); try { const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("Admin user created in Auth:", uid); await set(ref(db, 'adminConfig'), { setupComplete: true, adminUid: uid }); console.log("Admin setup complete in DB."); isAdminSetupComplete = true; designatedAdminUid = uid; await signOut(auth); alert("Admin account created! Please login now."); await handleInitialLoad(); } catch (error) { console.error("Admin Setup Error:", error); let message = `Setup failed: ${error.message}`; if (error.code === 'auth/email-already-in-use') message = "Email already in use."; else if (error.code === 'auth/weak-password') message = "Password is too weak."; else if (error.code === 'auth/invalid-email') message = "Invalid email format."; else if (error.code === 'permission-denied') message = "Setup failed: Permission denied writing config. Check Firebase Rules for '/adminConfig'."; showStatus(elements.setupStatus, message, "danger", false); isAdminSetupComplete = false; designatedAdminUid = null; } finally { showLoader(false); } }
        async function handleInitialLoad() { if (!auth || !db) return; showLoader(true); await checkAdminSetup(); elements.setupSection.style.display = 'none'; elements.loginSection.style.display = 'none'; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; if (!isAdminSetupComplete) { elements.setupSection.style.display = 'block'; console.log("Showing Setup Form"); } else { elements.loginSection.style.display = 'block'; console.log("Showing Login Form"); } showLoader(false); }

        // --- Auth State Change Handler --- (No change needed)
        async function handleAdminAuthStateChange(user) { if (!auth || !db) return; console.log("Auth State Changed. User:", user ? user.uid : 'null'); showLoader(true); currentAdminUser = user; detachAllAdminListeners(); if (user) { if (!designatedAdminUid) await checkAdminSetup(); if (isDesignatedAdmin(user)) { console.log("Admin Authenticated & Authorized:", user.email); if (elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent = user.email; elements.authContainer.style.display = 'none'; elements.mainArea.style.display = 'block'; await loadSettings(); showAdminSection('dashboard-section'); setupRealtimeAdminListeners(); } else { console.warn("Unauthorized user login attempt:", user.email, "| UID:", user.uid, "| Expected:", designatedAdminUid); alert(`Access Denied. ${user.email} is not the designated admin.`); await logoutAdminUser(); return; } } else { console.log("Auth State: Logged Out"); currentAdminUser = null; designatedAdminUid = null; isAdminSetupComplete = false; elements.mainArea.style.display = 'none'; elements.authContainer.style.display = 'block'; gameDataCache = {}; userDataCache = {}; fullUserDataCache = {}; appSettings = {}; if(elements.adminHeaderLogo) { elements.adminHeaderLogo.src='https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display='none'; } if(elements.adminPageTitle) elements.adminPageTitle.textContent='Admin Panel'; document.title='Admin Panel'; if(elements.adminUserEmailDisplay) elements.adminUserEmailDisplay.textContent=''; Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '--'); if(elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent='0'; elements.pendingWithdrawalCountBadge.style.display='none';} if(elements.userSearchInput) elements.userSearchInput.value = ''; await handleInitialLoad(); } setTimeout(() => showLoader(false), 150); }

        // --- Database Load Functions ---

        // *** MODIFIED: loadDashboardStats ***
        async function loadDashboardStats() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Loading dashboard stats...");
            clearStatus(elements.dashboardStatus);

            // Reset stats text
            Object.values(elements).filter(el => el.id?.startsWith('stat')).forEach(el => el.textContent = '...');

            const usersRef = ref(db, 'users');
            const gamesRef = ref(db, 'games');
            const promotionsRef = ref(db, 'promotions');
            const tournamentsRef = ref(db, 'tournaments');
            const withdrawalsRef = ref(db, 'withdrawals');

            // Queries (adjust as needed for performance, might fetch all withdrawals if indexed well)
            const activeTournamentsQuery = query(tournamentsRef, orderByChild('status')); // Filter client-side
            const pendingWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('pending'));
            const completedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('completed'));
            const rejectedWithdrawalsQuery = query(withdrawalsRef, orderByChild('status'), equalTo('rejected'));

            const results = await Promise.allSettled([
                get(usersRef), get(gamesRef), get(promotionsRef),
                get(activeTournamentsQuery), get(pendingWithdrawalsQuery),
                get(completedWithdrawalsQuery), get(rejectedWithdrawalsQuery)
            ]);

            let errorsFound = false;
            const setError = (element) => { element.textContent = 'Error'; errorsFound = true; };

            // Process Users
            if (results[0].status === 'fulfilled') elements.statTotalUsers.textContent = results[0].value.exists() ? results[0].value.size : 0;
            else { console.error("Err Users:", results[0].reason); setError(elements.statTotalUsers); showStatus(elements.dashboardStatus, `Err Users: ${results[0].reason?.message}`, "warning"); }

            // Process Games
            if (results[1].status === 'fulfilled') elements.statTotalGames.textContent = results[1].value.exists() ? results[1].value.size : 0;
            else { console.error("Err Games:", results[1].reason); setError(elements.statTotalGames); }

            // Process Promotions
            if (results[2].status === 'fulfilled') elements.statTotalPromotions.textContent = results[2].value.exists() ? results[2].value.size : 0;
            else { console.error("Err Promos:", results[2].reason); setError(elements.statTotalPromotions); }

            // Process Tournaments (Active/Upcoming & Finished)
            if (results[3].status === 'fulfilled') {
                let activeCount = 0; let finishedCount = 0;
                if (results[3].value.exists()) {
                    results[3].value.forEach(child => {
                        const status = child.val()?.status;
                        if (status === 'ongoing' || status === 'upcoming') activeCount++;
                        else if (status === 'completed' || status === 'result' || status === 'cancelled') finishedCount++;
                    });
                }
                elements.statActiveTournaments.textContent = activeCount;
                elements.statFinishedTournaments.textContent = finishedCount;
            } else {
                console.error("Err Tournaments:", results[3].reason);
                setError(elements.statActiveTournaments); setError(elements.statFinishedTournaments);
                if (results[3].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Tournament query fail. Add '.indexOn': 'status' to '/tournaments' rules.", "warning", false);
                else showStatus(elements.dashboardStatus, `Err Tournaments: ${results[3].reason?.message}`, "warning");
            }

            // Process Pending Withdrawals
            if (results[4].status === 'fulfilled') {
                const count = results[4].value.exists() ? results[4].value.size : 0;
                elements.statPendingWithdrawals.textContent = count;
                elements.pendingWithdrawalCountBadge.textContent = count;
                elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none';
            } else {
                console.error("Err Pending Withdrawals:", results[4].reason);
                setError(elements.statPendingWithdrawals); elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block';
                if (results[4].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "CRITICAL: Pending withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false);
                else showStatus(elements.dashboardStatus, `Err Pending Withdrawals: ${results[4].reason?.message}`, "warning");
            }

             // Process Completed Withdrawals
            if (results[5].status === 'fulfilled') elements.statCompletedWithdrawals.textContent = results[5].value.exists() ? results[5].value.size : 0;
            else { console.error("Err Completed Withdrawals:", results[5].reason); setError(elements.statCompletedWithdrawals); if (results[5].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Completed withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); }

             // Process Rejected Withdrawals
            if (results[6].status === 'fulfilled') elements.statRejectedWithdrawals.textContent = results[6].value.exists() ? results[6].value.size : 0;
            else { console.error("Err Rejected Withdrawals:", results[6].reason); setError(elements.statRejectedWithdrawals); if (results[6].reason?.message?.includes("index")) showStatus(elements.dashboardStatus, "WARNING: Rejected withdrawal query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "warning", false); }


            console.log("Dashboard stats loading complete.", errorsFound ? "Errors occurred." : "");
        }

        // *** MODIFIED: loadGames (adds Edit Button) ***
        async function loadGames() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const gamesRef = ref(db, 'games');
             elements.gamesTableBody.innerHTML = tableLoadingPlaceholderHtml(4);
             gameDataCache = {}; // Reset cache
             clearStatus(elements.gamesStatus);

             try {
                 const snapshot = await get(gamesRef);
                 let tableHtml = '';
                 if (snapshot.exists()) {
                     snapshot.forEach(childSnapshot => {
                         const gameId = childSnapshot.key;
                         const game = childSnapshot.val();
                         if (game && game.name) {
                            gameDataCache[gameId] = game.name; // Populate cache
                            tableHtml += `
                                <tr>
                                    <td><img src="${sanitizeHTML(game.imageUrl || 'https://via.placeholder.com/60x40/1E293B/94A3B8?text=N/A')}" alt="${sanitizeHTML(game.name)}" class="preview-img"></td>
                                    <td>${sanitizeHTML(game.name)}</td>
                                    <td><small class="text-muted">${sanitizeHTML(gameId)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:nth-child(3) > small" title="Copy Game ID"></i></td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-info btn-edit-game" data-id="${sanitizeHTML(gameId)}" title="Edit Game"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete-game" data-id="${sanitizeHTML(gameId)}" title="Delete Game"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>`;
                         } else { console.warn("Skipping invalid game data:", gameId, game); }
                     });
                 }
                 elements.gamesTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">No games found. Add one using the button above.</td></tr>`;
                 // Update dashboard count if visible
                 if (elements.dashboardSection?.classList.contains('active')) {
                     elements.statTotalGames.textContent = Object.keys(gameDataCache).length;
                 }

             } catch (error) {
                 console.error("Error loading games:", error);
                 elements.gamesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error loading games: ${error.message}. Check console & Rules.</td></tr>`;
                 showStatus(elements.gamesStatus, `Error loading games: ${error.message}. Check Rules.`, 'danger', false);
                 if (elements.dashboardSection?.classList.contains('active')) elements.statTotalGames.textContent = 'Error';
             }
         }

        // *** MODIFIED: loadPromotions (adds Edit Button) ***
        async function loadPromotions() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const promotionsRef = ref(db, 'promotions');
             elements.promotionsTableBody.innerHTML = tableLoadingPlaceholderHtml(3);
             clearStatus(elements.promotionsStatus);
             let promoCount = 0;
             try {
                 const snapshot = await get(promotionsRef);
                 let tableHtml = '';
                 if (snapshot.exists()) {
                    promoCount = snapshot.size;
                     snapshot.forEach(childSnapshot => {
                         const promoId = childSnapshot.key;
                         const promo = childSnapshot.val();
                          if (promo && promo.imageUrl) {
                            const displayLink = promo.link ? sanitizeHTML(promo.link) : '';
                            const shortLink = displayLink.length > 50 ? displayLink.substring(0, 50) + '...' : displayLink;
                            tableHtml += `
                                <tr>
                                    <td><img src="${sanitizeHTML(promo.imageUrl)}" alt="Promotion" class="preview-img"></td>
                                    <td>${promo.link ? `<a href="${displayLink}" target="_blank" class="text-info" title="${displayLink}">${shortLink}</a>` : '<span class="text-muted">No Link</span>'}</td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-info btn-edit-promo" data-id="${sanitizeHTML(promoId)}" title="Edit Promotion"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-sm btn-danger btn-delete-promo" data-id="${sanitizeHTML(promoId)}" title="Delete Promotion"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>`;
                          } else { console.warn("Skipping invalid promotion data:", promoId, promo); }
                     });
                 }
                 elements.promotionsTableBody.innerHTML = tableHtml || `<tr><td colspan="3" class="text-center p-3 text-muted">No promotions found.</td></tr>`;
                 // Update dashboard count if visible
                 if (elements.dashboardSection?.classList.contains('active')) {
                     elements.statTotalPromotions.textContent = promoCount;
                 }

             } catch (error) {
                 console.error("Error loading promotions:", error);
                 elements.promotionsTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-3 text-danger">Error loading promotions: ${error.message}. Check console & Rules.</td></tr>`;
                  showStatus(elements.promotionsStatus, `Error loading promotions: ${error.message}. Check Rules.`, 'danger', false);
                  if (elements.dashboardSection?.classList.contains('active')) elements.statTotalPromotions.textContent = 'Error';
             }
         }

        // *** MODIFIED: loadTournaments (adds player count column) ***
        async function loadTournaments() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const tournamentsRef = ref(db, 'tournaments');
             if (Object.keys(gameDataCache).length === 0) await loadGames(); // Ensure games loaded

             elements.tournamentsTableBody.innerHTML = tableLoadingPlaceholderHtml(8); // Increased colspan
             clearStatus(elements.tournamentsStatus);

             try {
                 const snapshot = await get(tournamentsRef);
                 let activeCount = 0; let finishedCount = 0;
                 let tableHtml = '';
                 if (snapshot.exists()) {
                     snapshot.forEach(childSnapshot => {
                         const tournamentId = childSnapshot.key;
                         const t = childSnapshot.val();
                         if (t && t.name && t.gameId && t.status) {
                             const gameName = gameDataCache[t.gameId] || `<small class="text-warning" title="ID: ${t.gameId}">Unknown</small>`;
                             let statusClass = 'secondary';
                             if (t.status === 'ongoing') { statusClass = 'success'; activeCount++; }
                             else if (t.status === 'upcoming') { statusClass = 'info'; activeCount++; }
                             else if (t.status === 'result') { statusClass = 'primary'; finishedCount++; }
                             else if (t.status === 'completed') { statusClass = 'secondary'; finishedCount++; }
                             else if (t.status === 'cancelled') { statusClass = 'danger'; finishedCount++; }

                             const statusBadge = `<span class="status-badge text-bg-${statusClass}">${t.status}</span>`;
                             const registeredCount = t.registeredPlayers ? Object.keys(t.registeredPlayers).length : 0;
                             const maxPlayers = t.maxPlayers > 0 ? `/${t.maxPlayers}` : '';
                             const playersDisplay = `${registeredCount}${maxPlayers}`;

                             tableHtml += `
                                 <tr>
                                     <td>${sanitizeHTML(t.name)}</td>
                                     <td>${gameName}</td>
                                     <td>${formatCurrency(t.entryFee)}</td>
                                     <td>${formatCurrency(t.prizePool)}</td>
                                     <td>${formatDate(t.startTime)}</td>
                                     <td>${statusBadge}</td>
                                     <td>${playersDisplay}</td>
                                     <td class="action-buttons">
                                         <button class="btn btn-sm btn-info btn-edit-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Edit"><i class="bi bi-pencil-square"></i></button>
                                         <button class="btn btn-sm btn-secondary btn-view-registered" data-id="${sanitizeHTML(tournamentId)}" data-name="${sanitizeHTML(t.name)}" title="View Players"><i class="bi bi-people"></i></button>
                                         <button class="btn btn-sm btn-danger btn-delete-tournament" data-id="${sanitizeHTML(tournamentId)}" title="Delete"><i class="bi bi-trash"></i></button>
                                     </td>
                                 </tr>`;
                         } else { console.warn("Skipping invalid tournament data:", tournamentId, t); }
                     });
                 }
                 elements.tournamentsTableBody.innerHTML = tableHtml || `<tr><td colspan="8" class="text-center p-3 text-muted">No tournaments found.</td></tr>`;

                 // Update dashboard counts if visible
                 if (elements.dashboardSection?.classList.contains('active')) {
                     elements.statActiveTournaments.textContent = activeCount;
                     elements.statFinishedTournaments.textContent = finishedCount;
                 }

             } catch (error) {
                 console.error("Error loading tournaments:", error);
                 elements.tournamentsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`;
                 showStatus(elements.tournamentsStatus, `Error loading tournaments: ${error.message}. Check Rules.`, 'danger', false);
                 if (elements.dashboardSection?.classList.contains('active')) {
                     elements.statActiveTournaments.textContent = 'Error';
                     elements.statFinishedTournaments.textContent = 'Error';
                 }
             }
         }

        // Helper function to render the users table
        function renderUsersTable(usersArray) {
            let tableHtml = '';
            if (usersArray?.length > 0) {
                // Sort alphabetically by display name, case-insensitive
                usersArray.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '', undefined, { sensitivity: 'base' }));
                usersArray.forEach(user => {
                    if (user?.email && user.uid) {
                        const status = user.status || 'active';
                        const statusBadge = `<span class="status-badge text-bg-${status === 'active' ? 'success' : 'danger'}">${status}</span>`;
                        tableHtml += `
                            <tr>
                                <td><small class="text-muted">${sanitizeHTML(user.uid)}</small> <i class="bi bi-clipboard copy-btn ms-1" data-target="td:first-child > small" title="Copy UID"></i></td>
                                <td>${sanitizeHTML(user.displayName || 'N/A')}</td>
                                <td>${sanitizeHTML(user.email)}</td>
                                <td>${formatCurrency(user.balance)}</td>
                                <td>${statusBadge}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-sm btn-info btn-view-user" data-id="${sanitizeHTML(user.uid)}" title="View/Edit"><i class="bi bi-eye"></i></button>
                                    <button class="btn btn-sm btn-danger btn-delete-user" data-id="${sanitizeHTML(user.uid)}" title="Delete (DB Only)"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>`;
                    }
                });
            }
            elements.usersTableBody.innerHTML = tableHtml || `<tr><td colspan="6" class="text-center p-3 text-muted">No users found matching criteria.</td></tr>`;
        }

        async function loadUsers() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const usersRef = ref(db, 'users');
            elements.usersTableBody.innerHTML = tableLoadingPlaceholderHtml(6);
            userDataCache = {}; fullUserDataCache = {}; // Reset caches
            clearStatus(elements.usersStatus);
            elements.userSearchInput.value = ''; // Clear search

            const listenerKey = 'users';
            if (dbListeners[listenerKey]) try { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached previous users listener."); } catch(e) { console.warn("Could not detach users listener", e); }

            dbListeners[listenerKey] = onValue(usersRef, (snapshot) => {
                 console.log("Users data received via listener.");
                 let userCount = 0; const usersArray = [];
                 fullUserDataCache = {}; userDataCache = {}; // Rebuild caches

                 if (snapshot.exists()) {
                     snapshot.forEach(childSnapshot => {
                         userCount++;
                         const userId = childSnapshot.key;
                         const user = childSnapshot.val();
                         if (user && user.email) {
                            user.uid = userId;
                            fullUserDataCache[userId] = user;
                            userDataCache[userId] = { displayName: user.displayName || 'N/A', email: user.email, status: user.status || 'active', balance: user.balance || 0, winningCash: user.winningCash || 0 };
                            usersArray.push(user);
                         } else { console.warn("Skipping invalid user data:", userId, user); }
                     });
                 }

                 renderUsersTable(usersArray); // Render initially

                 if (elements.dashboardSection?.classList.contains('active')) {
                     elements.statTotalUsers.textContent = userCount;
                 }
                 console.log("Users table updated. Count:", userCount);

            }, (error) => {
                 console.error("Error listening to users:", error);
                 elements.usersTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-3 text-danger">Error: ${error.message}. Check Rules.</td></tr>`;
                 showStatus(elements.usersStatus, `Error listening to users: ${error.message}. Check Rules.`, 'danger', false);
                 fullUserDataCache = {}; userDataCache = {};
                 if (elements.dashboardSection?.classList.contains('active')) elements.statTotalUsers.textContent = 'Error';
                 try { if (dbListeners[listenerKey]) { off(usersRef, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log("Detached failed users listener."); } } catch(e) { console.warn("Could not detach failed users listener.", e); }
            });
             console.log("Attached new users listener.");
        }

        async function loadWithdrawals(status = 'pending') {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const targetTableBody = getElement(`${status}WithdrawalsTableBody`);
             if (!targetTableBody) { console.error(`Table body not found: ${status}`); return; }
             const q = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(status));
             targetTableBody.innerHTML = tableLoadingPlaceholderHtml(status === 'pending' ? 5 : 6);
             if (status === 'pending') clearStatus(elements.withdrawalsStatus);

             const listenerKey = `withdrawals-${status}`;
             if (dbListeners[listenerKey]) try { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached previous ${status} withdrawals listener.`); } catch (e) { console.warn(`Could not detach ${listenerKey}`, e); }

             dbListeners[listenerKey] = onValue(q, async (snapshot) => {
                 console.log(`${status} withdrawals data received.`);
                 let tableHtml = ''; let count = 0;
                 targetTableBody.innerHTML = '';

                 if (snapshot.exists()) {
                     count = snapshot.size;
                     const userIds = new Set();
                     snapshot.forEach(child => { if (child.val()?.userId && !userDataCache[child.val().userId]) userIds.add(child.val().userId); });

                     if (userIds.size > 0) {
                         console.log(`Fetching ${userIds.size} missing basic user details for ${status} withdrawals...`);
                         const promises = Array.from(userIds).map(uid =>
                             get(ref(db, `users/${uid}`)).then(us => {
                                 if (us.exists()) { const u = us.val(); userDataCache[uid] = { displayName: u.displayName || 'N/A', email: u.email || uid, status: u.status || 'unknown' }; }
                                 else { userDataCache[uid] = { displayName: 'Unknown User', email: uid, status: 'deleted' }; }
                             }).catch(err => { console.warn(`Failed fetch user ${uid}`, err); userDataCache[uid] = { displayName: 'Error Fetching', email: uid, status: 'error' }; })
                         );
                         await Promise.allSettled(promises);
                         console.log("Missing user details fetch complete.");
                     }

                     // Sort by requestTimestamp descending
                     const withdrawals = [];
                     snapshot.forEach(child => withdrawals.push({ id: child.key, ...child.val() }));
                     withdrawals.sort((a, b) => (b.requestTimestamp || 0) - (a.requestTimestamp || 0));

                     withdrawals.forEach(w => {
                          if (w && w.userId && w.amount != null && w.requestTimestamp) {
                              const user = userDataCache[w.userId] || { displayName: 'Loading...', email: w.userId, status: 'unknown' };
                              const userDisplay = `${sanitizeHTML(user.displayName)} (<small class="text-muted" title="${w.userId}">${sanitizeHTML(user.email)}</small>)`;
                              let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A');
                              if (w.methodDetails?.accountInfo) { methodDisplay += `<small class="text-muted d-block" title="${sanitizeHTML(w.methodDetails.accountInfo)}">${sanitizeHTML(String(w.methodDetails.accountInfo)).substring(0, 40)}${String(w.methodDetails.accountInfo).length > 40 ? '...' : ''}</small>`; }
                              const requestTime = formatDate(w.requestTimestamp);
                              const processedTime = formatDate(w.processedAt);

                              let rowHtml = `<tr><td>${requestTime}</td>`;
                              if (status !== 'pending') rowHtml += `<td>${processedTime}</td>`;
                              rowHtml += `<td>${userDisplay}</td><td>${formatCurrency(w.amount)}</td><td>${methodDisplay}</td>`;

                              if (status === 'pending') {
                                  rowHtml += `<td class="action-buttons"><button class="btn btn-sm btn-success btn-approve-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Approve"><i class="bi bi-check-circle"></i></button> <button class="btn btn-sm btn-danger btn-reject-withdrawal" data-id="${sanitizeHTML(w.id)}" data-userid="${sanitizeHTML(w.userId)}" title="Reject"><i class="bi bi-x-circle"></i></button></td>`;
                              } else if (status === 'completed') { const note = sanitizeHTML(w.adminNote || ''); rowHtml += `<td><small title="${note}">${note.substring(0, 30)}${ note.length > 30 ? '...' : ''}</small></td>`; }
                              else if (status === 'rejected') { const reason = sanitizeHTML(w.rejectReason || ''); rowHtml += `<td><small title="${reason}">${reason.substring(0, 30)}${ reason.length > 30 ? '...' : ''}</small></td>`; }
                              rowHtml += `</tr>`;
                              tableHtml += rowHtml;
                          } else { console.warn(`Skipping invalid ${status} withdrawal:`, w.id, w); }
                     });
                 }
                 const emptyColspan = status === 'pending' ? 5 : 6;
                 targetTableBody.innerHTML = tableHtml || `<tr><td colspan="${emptyColspan}" class="text-center p-3 text-muted">No ${status} withdrawals found.</td></tr>`;

                  if (status === 'pending') {
                      if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; }
                      if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = count;
                  } else if (status === 'completed' && elements.dashboardSection?.classList.contains('active') && elements.statCompletedWithdrawals) {
                      elements.statCompletedWithdrawals.textContent = count;
                  } else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active') && elements.statRejectedWithdrawals) {
                      elements.statRejectedWithdrawals.textContent = count;
                  }
                  console.log(`${status} withdrawals table updated. Count:`, count);

             }, (error) => {
                 console.error(`Error listening to ${status} withdrawals:`, error);
                 const errorColspan = status === 'pending' ? 5 : 6;
                 targetTableBody.innerHTML = `<tr><td colspan="${errorColspan}" class="text-center p-3 text-danger">Error loading: ${error.message}. Check Rules/Index.</td></tr>`;
                 showStatus(elements.withdrawalsStatus, `Error loading ${status} withdrawals: ${error.message}. Check Rules/Index.`, 'danger', false);
                 if (status === 'pending') { if (error?.message?.includes("index")) showStatus(elements.withdrawalsStatus, "CRITICAL: Pending query fail. Add '.indexOn': 'status' to '/withdrawals' rules.", "danger", false); if(elements.pendingWithdrawalCountBadge){ elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block';} if (elements.dashboardSection?.classList.contains('active')) elements.statPendingWithdrawals.textContent = 'Error'; }
                 else if (status === 'completed' && elements.dashboardSection?.classList.contains('active')) elements.statCompletedWithdrawals.textContent = 'Error';
                 else if (status === 'rejected' && elements.dashboardSection?.classList.contains('active')) elements.statRejectedWithdrawals.textContent = 'Error';
                 try { if (dbListeners[listenerKey]) { off(q, 'value', dbListeners[listenerKey]); delete dbListeners[listenerKey]; console.log(`Detached failed ${status} listener.`); } } catch(e) { console.warn(`Could not detach failed ${status} listener.`, e); }
             });
              console.log(`Attached new listener for ${status} withdrawals.`);
         }

        async function loadSettings() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             console.log("Loading settings...");
             elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
             clearStatus(elements.settingsStatus);
             try {
                 const snapshot = await get(ref(db, 'settings'));
                 if (snapshot.exists()) {
                     appSettings = snapshot.val() || {};
                     elements.settingLogoUrlInput.value = appSettings.logoUrl || '';
                     elements.settingAppNameInput.value = appSettings.appName || '';
                     elements.settingMinWithdrawInput.value = appSettings.minWithdraw || 0;
                     elements.settingReferralBonusInput.value = appSettings.referralBonus || 0;
                     elements.settingSupportContactInput.value = appSettings.supportContact || '';
                     elements.settingUpiDetailsInput.value = appSettings.upiDetails || '';
                     elements.settingPolicyPrivacyInput.value = appSettings.policyPrivacy || '';
                     elements.settingPolicyTermsInput.value = appSettings.policyTerms || '';
                     elements.settingPolicyRefundInput.value = appSettings.policyRefund || '';
                     elements.settingPolicyFairPlayInput.value = appSettings.policyFairPlay || '';
                     if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; }
                     document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`;
                     console.log("Settings loaded and applied.");
                 } else {
                     console.log("No settings found.");
                     showStatus(elements.settingsStatus, "No settings found. Please configure.", "info", false);
                     elements.appSettingsForm.reset(); appSettings = {};
                     if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel';
                 }
             } catch (error) {
                 console.error("Error loading settings:", error);
                 showStatus(elements.settingsStatus, `Error loading settings: ${error.message}. Check Rules.`, "danger", false);
                 appSettings = {}; if(elements.adminHeaderLogo) elements.adminHeaderLogo.style.display = 'none'; document.title = 'Admin Panel';
             } finally {
                 elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false);
             }
         }

        // --- ImgBB Upload Function --- (No changes needed from previous version)
        const IMGBB_API_KEY = '1579b196953465c653d3639ab091448c'; // Note: Keeping this for functionality, replace if needed
        async function uploadToImgBB(file, statusElement) { if (!file) throw new Error("File not selected."); if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY') { console.error("ImgBB API Key missing or is a placeholder!"); throw new Error("ImgBB API Key not set."); } const formData = new FormData(); formData.append('image', file); if (statusElement) { statusElement.textContent = 'Uploading...'; statusElement.style.color = 'var(--text-secondary)'; statusElement.style.display = 'block'; } try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); if (!response.ok) { let errorMsg = `ImgBB upload failed: HTTP ${response.status}`; try { const errorData = await response.json(); errorMsg += ` - ${errorData?.error?.message || response.statusText}`; } catch (e) {} throw new Error(errorMsg); } const data = await response.json(); if (data.success) { console.log('ImgBB upload successful. URL:', data.data.url); if (statusElement) statusElement.textContent = 'Upload complete!'; return data.data.url; } else { console.error('ImgBB upload failed:', data); throw new Error(`ImgBB upload failed: ${data.error?.message || 'Unknown error'}`); } } catch (error) { console.error('ImgBB Fetch error:', error); if (statusElement) { statusElement.textContent = `Upload Error: ${error.message}`; statusElement.style.color = 'var(--danger-color)'; } throw error; } }

        // --- Database Save/Update/Delete Functions ---

        // *** MODIFIED: saveGame (Handles Add & Edit) ***
        async function saveGame() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const gameId = elements.gameEditId.value; // Check if editing
            const isEditing = !!gameId;
            const name = elements.gameNameInput.value.trim();
            const imageUrlInput = elements.gameImageUrlInput.value.trim();
            const imageFile = elements.gameImageFileInput.files[0];

            const statusEl = elements.gameStatus; // Status inside modal
            const imgbbStatusEl = elements.gameForm?.querySelector('.imgbb-upload-status');
            clearStatus(statusEl);
            if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; }

            if (!name) { showStatus(statusEl, "Game Name is required.", "warning"); return; }
            // Require URL unless a new file is being uploaded
            if (!imageUrlInput && !imageFile && !isEditing) { // Must provide URL or file for new game
                 showStatus(statusEl, "Image URL or File Upload required for new game.", "warning"); return;
            }
             if (!imageUrlInput && !imageFile && isEditing) { // Must have URL if editing and not uploading new file
                 showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return;
             }

            showLoader(true);
            elements.saveGameBtn.disabled = true;
            let finalImageUrl = imageUrlInput; // Start with the input URL

            try {
                // Upload to ImgBB ONLY if a new file is selected
                if (imageFile) {
                    finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl);
                }

                if (!finalImageUrl) {
                     throw new Error("Image URL is missing after potential upload.");
                }

                const gameData = { name: name, imageUrl: finalImageUrl };

                if (isEditing) {
                    gameData.updatedAt = serverTimestamp();
                    const gameRef = ref(db, `games/${gameId}`);
                    await update(gameRef, gameData);
                    console.log("Game updated successfully:", gameId);
                    showStatus(elements.gamesStatus, "Game updated successfully!", "success", 3000); // Show status in main section
                } else {
                    gameData.createdAt = serverTimestamp();
                    const newGameRef = push(ref(db, 'games'));
                    await set(newGameRef, gameData);
                    console.log("Game added successfully, key:", newGameRef.key);
                    showStatus(elements.gamesStatus, "Game added successfully!", "success", 3000); // Show status in main section
                }

                elements.gameForm.reset();
                elements.gameEditId.value = ''; // Clear edit ID
                if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; }
                getModalInstance(elements.gameModalEl)?.hide();
                loadGames(); // Refresh list

            } catch (error) {
                console.error("Error saving game:", error);
                showStatus(statusEl, `Error saving game: ${error.message}. Check console & Rules.`, "danger", false); // Show error in modal
                 if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) {
                      imgbbStatusEl.style.display = 'none';
                 }
            } finally {
                showLoader(false);
                elements.saveGameBtn.disabled = false;
            }
        }

        // *** MODIFIED: savePromotion (Handles Add & Edit) ***
        async function savePromotion() {
             if (!db || !isDesignatedAdmin(currentAdminUser)) return;
             const promoId = elements.promotionEditId.value;
             const isEditing = !!promoId;
             const promoLink = elements.promoLinkInput.value.trim();
             const imageUrlInput = elements.promoImageUrlInput.value.trim();
             const imageFile = elements.promoImageFileInput.files[0];

             const statusEl = elements.promotionStatus; // Status inside modal
             const imgbbStatusEl = elements.promotionForm?.querySelector('.imgbb-upload-status');
             clearStatus(statusEl);
             if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; }

             if (!imageUrlInput && !imageFile && !isEditing) {
                 showStatus(statusEl, "Image URL or File Upload required for new promotion.", "warning"); return;
             }
             if (!imageUrlInput && !imageFile && isEditing) {
                 showStatus(statusEl, "Image URL cannot be empty when editing.", "warning"); return;
             }

             showLoader(true);
             elements.savePromotionBtn.disabled = true;
             let finalImageUrl = imageUrlInput;

             try {
                 if (imageFile) {
                     finalImageUrl = await uploadToImgBB(imageFile, imgbbStatusEl);
                 }

                 if (!finalImageUrl) {
                     throw new Error("Image URL is missing after potential upload.");
                 }

                 const promoData = { imageUrl: finalImageUrl, link: promoLink || null };

                 if (isEditing) {
                    promoData.updatedAt = serverTimestamp();
                    const promoRef = ref(db, `promotions/${promoId}`);
                    await update(promoRef, promoData);
                    console.log("Promotion updated successfully:", promoId);
                    showStatus(elements.promotionsStatus, "Promotion updated successfully!", "success", 3000); // Show status in section
                 } else {
                    promoData.createdAt = serverTimestamp();
                    const newPromoRef = push(ref(db, 'promotions'));
                    await set(newPromoRef, promoData);
                    console.log("Promotion added successfully, key:", newPromoRef.key);
                    showStatus(elements.promotionsStatus, "Promotion added successfully!", "success", 3000); // Show status in section
                 }

                 elements.promotionForm.reset();
                 elements.promotionEditId.value = ''; // Clear edit ID
                 if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; }
                 getModalInstance(elements.promotionModalEl)?.hide();
                 loadPromotions(); // Refresh list

             } catch (error) {
                 console.error("Error saving promotion:", error);
                 showStatus(statusEl, `Error saving promotion: ${error.message}. Check console & Rules.`, "danger", false); // Show error in modal
                  if (imgbbStatusEl && !imgbbStatusEl.textContent.includes('Error')) {
                      imgbbStatusEl.style.display = 'none';
                 }
             } finally {
                 showLoader(false);
                 elements.savePromotionBtn.disabled = false;
             }
         }

        // Save Tournament (No change needed)
        async function saveTournament(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.addTournamentStatus; clearStatus(statusEl); const gameId = elements.tournamentGameSelect.value; const name = elements.tournamentNameInput.value.trim(); const startTimeStr = elements.tournamentStartTimeInput.value; const entryFeeStr = elements.tournamentEntryFeeInput.value; const prizePoolStr = elements.tournamentPrizePoolInput.value; const perKillStr = elements.tournamentPerKillInput.value; const maxPlayersStr = elements.tournamentMaxPlayersInput.value; if (!gameId || !name || !startTimeStr) { showStatus(statusEl, "Game, Name, and Start Time required.", "warning"); return; } let startTimeTimestamp; try { startTimeTimestamp = new Date(startTimeStr).getTime(); if (isNaN(startTimeTimestamp)) throw new Error('Invalid Date'); } catch (e) { showStatus(statusEl, "Invalid Start Date & Time.", "warning"); return; } const entryFee = parseFloat(entryFeeStr) || 0; const prizePool = parseFloat(prizePoolStr) || 0; const perKillPrize = parseFloat(perKillStr) || 0; const maxPlayers = parseInt(maxPlayersStr) || 0; if (entryFee < 0 || prizePool < 0 || perKillPrize < 0 || maxPlayers < 0) { showStatus(statusEl, "Numeric values cannot be negative.", "warning"); return; } const tournamentData = { gameId: gameId, name: name, startTime: startTimeTimestamp, status: elements.tournamentStatusSelect.value, entryFee: entryFee, prizePool: prizePool, perKillPrize: perKillPrize, maxPlayers: maxPlayers, tags: elements.tournamentTagsInput.value.split(',').map(tag => tag.trim()).filter(tag => tag), description: elements.tournamentDescriptionInput.value.trim(), roomId: elements.tournamentRoomIdInput.value.trim() || null, roomPassword: elements.tournamentRoomPasswordInput.value.trim() || null, showIdPass: elements.tournamentShowIdPassCheckbox.checked, updatedAt: serverTimestamp() }; showLoader(true); elements.saveTournamentBtn.disabled = true; try { if (currentEditingTournamentId) { const tRef = ref(db, `tournaments/${currentEditingTournamentId}`); const existing = await get(tRef); if (existing.exists() && existing.val().registeredPlayers) tournamentData.registeredPlayers = existing.val().registeredPlayers; await update(tRef, tournamentData); console.log("Tournament updated:", currentEditingTournamentId); showStatus(statusEl, "Tournament updated!", "success", 3000); } else { tournamentData.createdAt = serverTimestamp(); const newRef = push(ref(db, 'tournaments')); await set(newRef, tournamentData); console.log("Tournament added:", newRef.key); showStatus(statusEl, "Tournament added!", "success", 3000); } elements.tournamentForm.reset(); currentEditingTournamentId = null; getModalInstance(elements.addTournamentModalEl)?.hide(); loadTournaments(); loadDashboardStats(); } catch (error) { console.error("Error saving tournament:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.saveTournamentBtn.disabled = false; } }

        // Delete Game (No change needed)
        async function deleteGame(gameId) { if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Game ID: ${gameId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.gamesStatus; clearStatus(statusEl); try { await remove(ref(db, `games/${gameId}`)); console.log("Game deleted from DB:", gameId); delete gameDataCache[gameId]; showStatus(statusEl, "Game data deleted.", "success", 3000); loadGames(); loadDashboardStats(); } catch (error) { console.error("Error deleting game:", error); showStatus(statusEl, `Error deleting game: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }

        // Delete Promotion (No change needed)
        async function deletePromotion(promoId) { if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Promotion ID: ${promoId}? Removes DB entry. Image on ImgBB NOT deleted. OK?`)) return; showLoader(true); const statusEl = elements.promotionsStatus; clearStatus(statusEl); try { await remove(ref(db, `promotions/${promoId}`)); console.log("Promotion deleted from DB:", promoId); showStatus(statusEl, "Promotion data deleted.", "success", 3000); loadPromotions(); loadDashboardStats(); } catch (error) { console.error("Error deleting promotion:", error); showStatus(statusEl, `Error deleting promotion: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }

        // Delete Tournament (No change needed)
        async function deleteTournament(tournamentId) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; if (!confirm(`DELETE Tournament ID: ${tournamentId}? Cannot be undone.`)) return; showLoader(true); const statusEl = elements.tournamentsStatus; clearStatus(statusEl); try { await remove(ref(db, `tournaments/${tournamentId}`)); console.log("Tournament deleted:", tournamentId); showStatus(statusEl, "Tournament deleted.", "success", 3000); loadTournaments(); loadDashboardStats(); } catch (error) { console.error("Error deleting tournament:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }

        // Save New User (No change needed)
        async function saveNewUser() { if (!auth || !db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.addUserStatus; clearStatus(statusEl); const name = elements.newUserNameInput.value.trim(); const email = elements.newUserEmailInput.value.trim(); const password = elements.newUserPasswordInput.value; const initialBalanceStr = elements.newUserInitialBalanceInput.value; if (!name || !email || !password) { showStatus(statusEl, "Name, Email, Password required.", "warning"); return; } if (password.length < 6) { showStatus(statusEl, "Password min 6 chars.", "warning"); return; } const initialBalance = parseFloat(initialBalanceStr) || 0; if (initialBalance < 0) { showStatus(statusEl, "Initial Balance cannot be negative.", "warning"); return; } if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showStatus(statusEl, "Invalid Email format.", "warning"); return; } showLoader(true); elements.saveNewUserBtn.disabled = true; try { const referralCode = Math.random().toString(36).substring(2, 10).toUpperCase(); const cred = await createUserWithEmailAndPassword(auth, email, password); const uid = cred.user.uid; console.log("User created in Auth:", uid, email); const userData = { uid: uid, email: email, displayName: name, balance: initialBalance, winningCash: 0, bonusCash: 0, status: 'active', createdAt: serverTimestamp(), referralCode: referralCode, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }; await set(ref(db, `users/${uid}`), userData); console.log("User data created in DB:", uid); showStatus(statusEl, `User ${name} created!`, "success", 4000); elements.addUserForm.reset(); getModalInstance(elements.addUserModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error creating user:", error); let msg = `Error: ${error.message}`; if (error.code === 'auth/email-already-in-use') msg = "Email already registered."; else if (error.code === 'auth/weak-password') msg = "Password too weak."; else if (error.code === 'auth/invalid-email') msg = "Invalid email format."; else if (error.code === 'permission-denied') msg = "Permission denied creating user/DB entry. Check Rules."; showStatus(statusEl, msg, "danger", false); } finally { showLoader(false); elements.saveNewUserBtn.disabled = false; } }

        // Update User Balance (No change needed)
        async function updateUserBalance(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.balanceUpdateStatus; clearStatus(statusEl); const userId = elements.editUserUid.value; const amountStr = elements.balanceUpdateAmountInput.value; const type = elements.balanceUpdateTypeSelect.value; const reason = elements.balanceUpdateReasonInput.value.trim(); if (!userId || !amountStr || !type || !reason) { showStatus(statusEl, "All fields required.", "warning"); return; } const amount = parseFloat(amountStr); if (isNaN(amount) || amount === 0) { showStatus(statusEl, "Invalid or zero amount.", "warning"); return; } showLoader(true); const userRefPath = `users/${userId}`; const updates = {}; try { const userSnapshot = await get(ref(db, userRefPath)); if (!userSnapshot.exists()) throw new Error(`User ${userId} not found.`); const user = userSnapshot.val(); const currentBalance = Number(user.balance || 0); const currentWinning = Number(user.winningCash || 0); const currentBonus = Number(user.bonusCash || 0); let newBalance = currentBalance; let newWinning = currentWinning; let newBonus = currentBonus; let logType = ''; switch (type) { case 'balance': newBalance += amount; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_deposit' : 'admin_deduction'; break; case 'winningCash': newWinning += amount; newBalance += amount; if (newWinning < 0) throw new Error("Winning cash cannot be negative."); updates[`${userRefPath}/winningCash`] = newWinning; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_winning_add' : 'admin_winning_deduct'; break; case 'bonusCash': newBonus += amount; newBalance += amount; if (newBonus < 0) throw new Error("Bonus cash cannot be negative."); updates[`${userRefPath}/bonusCash`] = newBonus; updates[`${userRefPath}/balance`] = newBalance; logType = amount > 0 ? 'admin_bonus_add' : 'admin_bonus_deduct'; break; default: throw new Error("Invalid balance type."); } if (newBalance < 0 && !confirm(`Warning: Negative total balance (${formatCurrency(newBalance)}). Proceed?`)) { showLoader(false); showStatus(statusEl, "Update cancelled.", "info"); return; } const txKey = push(ref(db, `transactions/${userId}`)).key; const txData = { type: logType, amount: amount, timestamp: serverTimestamp(), description: `Admin Update: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; updates[`transactions/${userId}/${txKey}`] = txData; await update(ref(db), updates); console.log(`Balance updated for ${userId}. New Bal: ${newBalance}, Win: ${newWinning}, Bonus: ${newBonus}`); elements.userDetailBalance.textContent = newBalance.toFixed(2); elements.userDetailWinning.textContent = newWinning.toFixed(2); elements.userDetailBonus.textContent = newBonus.toFixed(2); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; fullUserDataCache[userId].bonusCash = newBonus; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } showStatus(statusEl, "Balance updated!", "success", 3000); elements.updateBalanceForm.reset(); } catch (error) { console.error("Error updating balance:", error); showStatus(statusEl, `Error: ${error.message}`, "danger", false); } finally { showLoader(false); } }

        // Toggle User Block (No change needed)
        async function toggleUserBlock(event) { const button = event.target.closest('button'); if (!button || !db || !isDesignatedAdmin(currentAdminUser)) return; const userId = button.dataset.id; const currentAction = button.dataset.action; if (!userId || !currentAction) return; const newStatus = currentAction === 'block' ? 'blocked' : 'active'; if (!confirm(`Confirm ${currentAction} user ${userId}?`)) return; showLoader(true); button.disabled = true; const modalVisible = getModalInstance(elements.userModalEl)?._isShown; const statusEl = modalVisible && elements.editUserUid.value === userId ? elements.balanceUpdateStatus : elements.usersStatus; clearStatus(statusEl); try { await set(ref(db, `users/${userId}/status`), newStatus); console.log(`User ${userId} status set to ${newStatus}`); if (fullUserDataCache[userId]) fullUserDataCache[userId].status = newStatus; if (userDataCache[userId]) userDataCache[userId].status = newStatus; showStatus(statusEl, `User ${newStatus} successfully!`, "success", 3000); if (modalVisible && elements.editUserUid.value === userId) { elements.userDetailStatus.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1); elements.userDetailStatus.className = `fw-bold text-${newStatus === 'active' ? 'success' : 'danger'}`; button.textContent = newStatus === 'active' ? 'Block User' : 'Unblock User'; button.className = `btn btn-sm ${newStatus === 'active' ? 'btn-danger' : 'btn-success'}`; button.dataset.action = newStatus === 'active' ? 'block' : 'unblock'; } filterUsers(); } catch (error) { console.error(`Error ${currentAction}ing user:`, error); showStatus(statusEl, `Error ${currentAction}ing user: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); button.disabled = false; } }

        // Delete User (No change needed)
        async function deleteUser(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; const userName = fullUserDataCache[userId]?.displayName || fullUserDataCache[userId]?.email || userId; if (!confirm(`DELETE USER: ${userName} (UID: ${userId})?\n\nWARNING:\n- Removes user data from Realtime Database ONLY.\n- DOES NOT delete from Firebase Auth.\n- Associated data (transactions, etc.) may be orphaned.\n\nCannot be undone. Proceed?`)) return; showLoader(true); const statusEl = elements.usersStatus; clearStatus(statusEl); const modal = getModalInstance(elements.userModalEl); if (modal?._isShown) modal.hide(); try { await remove(ref(db, `users/${userId}`)); console.log("User deleted from DB:", userId); delete fullUserDataCache[userId]; delete userDataCache[userId]; showStatus(statusEl, `User ${userName} deleted from Database.`, "success", 5000); filterUsers(); loadDashboardStats(); } catch (error) { console.error("Error deleting user from DB:", error); showStatus(statusEl, `Error deleting user data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); } }

        // Open Withdrawal Modal (No change needed)
        async function openWithdrawalActionModal(withdrawalId, type) { if (!db || !withdrawalId || !type || !isDesignatedAdmin(currentAdminUser)) return; console.log(`Opening withdrawal modal: ${withdrawalId}, Action: ${type}`); showLoader(true); currentWithdrawalAction = { id: withdrawalId, type: type, userId: null }; elements.withdrawalRejectReasonInput.value = ''; elements.withdrawalApproveNoteInput.value = ''; elements.withdrawalRejectReasonDiv.style.display = 'none'; elements.withdrawalApproveNoteDiv.style.display = 'none'; elements.withdrawalRejectReasonInput.required = false; elements.withdrawalApproveNoteInput.required = false; clearStatus(elements.withdrawalActionStatus); elements.approveWithdrawalBtn.style.display = 'inline-block'; elements.rejectWithdrawalBtn.style.display = 'inline-block'; elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; const withdrawalRef = ref(db, `withdrawals/${withdrawalId}`); try { const snapshot = await get(withdrawalRef); if (!snapshot.exists()) throw new Error(`Withdrawal ${withdrawalId} not found.`); const w = snapshot.val(); currentWithdrawalAction.userId = w.userId; if (w.status !== 'pending') { alert(`Request already processed (Status: ${w.status}).`); showLoader(false); return; } let userDisplay = `UID: ${w.userId}`; const userId = w.userId; if (userId && userDataCache[userId]) { const u = userDataCache[userId]; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else if (userId) { try { const userSnap = await get(ref(db, `users/${userId}`)); if (userSnap.exists()) { const u = userSnap.val(); userDataCache[userId] = { displayName: u.displayName || 'N/A', email: u.email || userId, status: u.status || 'unknown' }; userDisplay = `${sanitizeHTML(u.displayName)} (<small class="text-muted" title="${userId}">${sanitizeHTML(u.email)}</small>)`; } else { userDataCache[userId] = { displayName: 'Unknown User', email: userId, status: 'deleted' }; userDisplay = `Unknown User (<small class="text-muted" title="${userId}">${userId}</small>)`; } } catch (err) { console.warn(`Could not fetch user ${userId}`, err); userDataCache[userId] = { displayName: 'Error Fetching', email: userId, status: 'error' }; userDisplay = `Error Fetching (<small class="text-muted" title="${userId}">${userId}</small>)`; } } let methodDisplay = sanitizeHTML(w.methodDetails?.methodName || w.method || 'N/A'); if (w.methodDetails?.accountInfo) methodDisplay += ` - ${sanitizeHTML(w.methodDetails.accountInfo)}`; elements.withdrawalDetailId.textContent = withdrawalId; elements.withdrawalDetailUser.innerHTML = userDisplay; elements.withdrawalDetailUserUid.textContent = userId || 'N/A'; elements.withdrawalDetailAmount.textContent = (w.amount || 0).toFixed(2); elements.withdrawalDetailMethod.textContent = methodDisplay; if (type === 'reject') { elements.withdrawalRejectReasonDiv.style.display = 'block'; elements.withdrawalRejectReasonInput.required = true; elements.approveWithdrawalBtn.style.display = 'none'; } else { elements.withdrawalApproveNoteDiv.style.display = 'block'; elements.rejectWithdrawalBtn.style.display = 'none'; } getModalInstance(elements.withdrawalActionModalEl)?.show(); } catch (error) { console.error("Error opening withdrawal modal:", error); alert(`Error fetching details: ${error.message}`); showStatus(elements.withdrawalsStatus, `Error fetching details: ${error.message}`, 'danger', false); } finally { showLoader(false); } }

        // Process Withdrawal (No change needed)
        async function processWithdrawalAction() { if (!db || !currentWithdrawalAction.id || !currentWithdrawalAction.type || !currentWithdrawalAction.userId || !isDesignatedAdmin(currentAdminUser)) { console.error("Withdrawal details missing or unauthorized."); showStatus(elements.withdrawalActionStatus, "Internal error/unauthorized.", "danger", false); return; } const statusEl = elements.withdrawalActionStatus; clearStatus(statusEl); const withdrawalId = currentWithdrawalAction.id; const actionType = currentWithdrawalAction.type; const userId = currentWithdrawalAction.userId; const updates = {}; const withdrawalRefPath = `withdrawals/${withdrawalId}`; let reason = ''; let adminNote = ''; let logType = ''; let logStatus = 'failed'; let refundRequired = false; showLoader(true); elements.approveWithdrawalBtn.disabled = true; elements.rejectWithdrawalBtn.disabled = true; try { const wSnapshot = await get(ref(db, withdrawalRefPath)); if (!wSnapshot.exists()) throw new Error("Withdrawal request not found."); const wData = wSnapshot.val(); const amount = Number(wData.amount || 0); if (wData.status !== 'pending') throw new Error(`Request already processed (Status: ${wData.status}).`); if (amount <= 0) throw new Error("Invalid amount."); if (actionType === 'reject') { reason = elements.withdrawalRejectReasonInput.value.trim(); if (!reason) { elements.rejectWithdrawalBtn.disabled = false; throw new Error("Rejection reason required."); } updates[`${withdrawalRefPath}/status`] = 'rejected'; updates[`${withdrawalRefPath}/rejectReason`] = reason; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = true; logType = 'withdrawal_rejected'; logStatus = 'completed'; } else { adminNote = elements.withdrawalApproveNoteInput.value.trim(); updates[`${withdrawalRefPath}/status`] = 'completed'; updates[`${withdrawalRefPath}/adminNote`] = adminNote || 'Approved'; updates[`${withdrawalRefPath}/processedAt`] = serverTimestamp(); updates[`${withdrawalRefPath}/processedBy`] = currentAdminUser.uid; refundRequired = false; logType = 'withdrawal_approved'; logStatus = 'completed'; } if (refundRequired) { const uSnapshot = await get(ref(db, `users/${userId}`)); if (!uSnapshot.exists()) throw new Error(`User ${userId} not found for refund.`); const user = uSnapshot.val(); const currentWinning = Number(user.winningCash || 0); const currentBalance = Number(user.balance || 0); const newWinning = currentWinning + amount; const newBalance = currentBalance + amount; updates[`users/${userId}/winningCash`] = newWinning; updates[`users/${userId}/balance`] = newBalance; const refundTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${refundTxKey}`] = { type: 'withdrawal_refund', amount: amount, timestamp: serverTimestamp(), description: `Refund rejected withdrawal: ${withdrawalId}. Reason: ${reason}`, status: 'completed', balanceAfter: newBalance, adminUid: currentAdminUser.uid }; console.log(`Prepared refund for ${userId}. New Bal: ${newBalance}`); if (fullUserDataCache[userId]) { fullUserDataCache[userId].balance = newBalance; fullUserDataCache[userId].winningCash = newWinning; } if (userDataCache[userId]) { userDataCache[userId].balance = newBalance; userDataCache[userId].winningCash = newWinning; } } const mainTxKey = push(ref(db, `transactions/${userId}`)).key; updates[`transactions/${userId}/${mainTxKey}`] = { type: logType, amount: 0, timestamp: serverTimestamp(), description: `Withdrawal ${actionType} by admin. ID: ${withdrawalId}. ${actionType === 'reject' ? `Reason: ${reason}` : `Note: ${adminNote}`}`, status: logStatus, withdrawalId: withdrawalId, adminUid: currentAdminUser.uid }; await update(ref(db), updates); console.log(`Withdrawal ${withdrawalId} ${actionType} processed.`); showStatus(elements.withdrawalsStatus, `Withdrawal ${actionType} successfully!`, "success", 4000); getModalInstance(elements.withdrawalActionModalEl)?.hide(); loadDashboardStats(); } catch (error) { console.error("Error processing withdrawal:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); if (getModalInstance(elements.withdrawalActionModalEl)?._isShown) { elements.approveWithdrawalBtn.disabled = false; elements.rejectWithdrawalBtn.disabled = false; } } }

        // Save Settings (No change needed)
        async function saveSettings(event) { event.preventDefault(); if (!db || !isDesignatedAdmin(currentAdminUser)) return; const statusEl = elements.settingsStatus; clearStatus(statusEl); const minW = parseFloat(elements.settingMinWithdrawInput.value) || 0; const refB = parseFloat(elements.settingReferralBonusInput.value) || 0; if (minW < 0 || refB < 0) { showStatus(statusEl, "Numeric values cannot be negative.", "warning"); return; } const settingsData = { logoUrl: elements.settingLogoUrlInput.value.trim(), appName: elements.settingAppNameInput.value.trim(), minWithdraw: minW, referralBonus: refB, supportContact: elements.settingSupportContactInput.value.trim(), upiDetails: elements.settingUpiDetailsInput.value.trim(), policyPrivacy: elements.settingPolicyPrivacyInput.value.trim(), policyTerms: elements.settingPolicyTermsInput.value.trim(), policyRefund: elements.settingPolicyRefundInput.value.trim(), policyFairPlay: elements.settingPolicyFairPlayInput.value.trim(), lastUpdated: serverTimestamp() }; showLoader(true); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true); try { await set(ref(db, 'settings'), settingsData); appSettings = settingsData; console.log("Settings saved:", appSettings); showStatus(statusEl, "Settings saved!", "success", 3000); if(elements.adminHeaderLogo) { const logoUrl = appSettings.logoUrl; elements.adminHeaderLogo.src = logoUrl || 'https://via.placeholder.com/35/1E293B/94A3B8?text=L'; elements.adminHeaderLogo.style.display = logoUrl ? 'inline-block' : 'none'; elements.adminHeaderLogo.alt = appSettings.appName ? `${appSettings.appName} Logo` : 'Logo'; } document.title = `${appSettings.appName || 'Gaming Tournament'} - Admin Panel`; } catch (error) { console.error("Error saving settings:", error); showStatus(statusEl, `Error: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.appSettingsForm?.querySelectorAll('input, textarea, button').forEach(el => el.disabled = false); } }
        
        // ===================================
        // NEW: THEME MANAGEMENT FUNCTIONS
        // ===================================

        /**
         * Loads the current theme from Firebase and populates the color pickers.
         * Falls back to the default theme if no theme is set in the DB.
         */
        async function loadThemeSettings() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Loading theme settings...");
            const statusEl = elements.themeStatus;
            clearStatus(statusEl);
            try {
                const settingsSnap = await get(ref(db, 'settings'));
                const currentTheme = settingsSnap.exists() ? settingsSnap.val().theme : null;

                if (currentTheme) {
                    console.log("Found custom theme in DB:", currentTheme);
                    populateThemePickers(currentTheme);
                } else {
                    console.log("No custom theme in DB, loading default.");
                    populateThemePickers(defaultTheme);
                    showStatus(statusEl, "Currently using the default theme. Customize and save to change it.", "info", 10000);
                }
            } catch (error) {
                console.error("Error loading theme settings:", error);
                showStatus(statusEl, `Error loading theme: ${error.message}`, "danger", false);
                populateThemePickers(defaultTheme); // Fallback to default on error
            }
        }

        /**
         * Populates the color picker inputs based on a theme object.
         * @param {object} theme - The theme object (e.g., defaultTheme, crimsonTheme).
         */
        function populateThemePickers(theme) {
            elements.themeColorPickers.forEach(picker => {
                const cssVar = picker.dataset.var;
                const colorValue = theme[cssVar] || '#000000'; // Fallback to black if property is missing
                picker.value = colorValue;
                // Also update the text input next to it
                const textInput = picker.parentElement.querySelector(`input[type="text"][data-target="${picker.id}"]`);
                if (textInput) {
                    textInput.value = colorValue;
                }
            });
        }

        /**
         * Saves the current colors from the pickers to Firebase under /settings/theme.
         */
        async function saveTheme() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            const statusEl = elements.themeStatus;
            clearStatus(statusEl);
            
            const themeData = {};
            elements.themeColorPickers.forEach(picker => {
                const cssVar = picker.dataset.var;
                // Basic validation for hex color
                if (cssVar && /^#[0-9A-F]{6}$/i.test(picker.value)) {
                    themeData[cssVar] = picker.value;
                } else {
                    console.warn(`Skipping invalid color for ${cssVar}: ${picker.value}`);
                }
            });

            // A special case for accent-gradient as it's derived
            if(themeData['--accent-color']) {
                themeData['--accent-gradient'] = `linear-gradient(to right, ${themeData['--accent-color']}, #FBBF24)`; // This could be improved, but is a simple approach
            }

            if (Object.keys(themeData).length < elements.themeColorPickers.length) {
                showStatus(statusEl, "One or more colors are invalid. Please check the values.", "warning");
                return;
            }

            showLoader(true);
            elements.saveThemeBtn.disabled = true;
            try {
                // We use update to avoid overwriting other settings
                await update(ref(db, 'settings'), { theme: themeData });
                console.log("Theme saved successfully:", themeData);
                showStatus(statusEl, "Theme saved successfully! Changes will appear for users in real-time.", "success", 5000);
            } catch (error) {
                console.error("Error saving theme:", error);
                showStatus(statusEl, `Error saving theme: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.saveThemeBtn.disabled = false;
            }
        }

        /**
         * Resets the theme by removing the theme object from Firebase.
         */
        async function resetTheme() {
            if (!db || !isDesignatedAdmin(currentAdminUser)) return;
            if (!confirm("Are you sure you want to reset to the default theme? This will remove your custom theme settings.")) {
                return;
            }
            const statusEl = elements.themeStatus;
            clearStatus(statusEl);
            showLoader(true);
            elements.resetThemeBtn.disabled = true;

            try {
                // To reset, we simply remove the 'theme' key from the settings
                await remove(ref(db, 'settings/theme'));
                console.log("Theme reset successfully.");
                showStatus(statusEl, "Theme has been reset to default.", "success", 5000);
                // Repopulate the pickers with the default values after reset
                populateThemePickers(defaultTheme);
            } catch (error) {
                console.error("Error resetting theme:", error);
                showStatus(statusEl, `Error resetting theme: ${error.message}. Check Rules.`, "danger", false);
            } finally {
                showLoader(false);
                elements.resetThemeBtn.disabled = false;
            }
        }


        // Add Demo Data (No change needed)
        async function addDemoData() { if (!db || !isDesignatedAdmin(currentAdminUser) || !confirm("Add sample demo data? Only adds if sections are empty.")) return; showLoader(true); elements.addDemoDataBtn.disabled = true; const sectionEl = querySel('#adminMainContent .section.active'); const statusEl = sectionEl?.querySelector('div[id$="Status"]') || elements.dashboardStatus; clearStatus(statusEl); let added = []; const now = Date.now(); try { const gamesRef = ref(db, 'games'); const gamesSnap = await get(gamesRef); let demoGameId = null; if (!gamesSnap.exists() || gamesSnap.size === 0) { const newRef = push(gamesRef); demoGameId = newRef.key; await set(newRef, { name: "Demo Game (BGMI)", imageUrl: "https://i.ibb.co/4Z5hPVzp/20250418-150058.jpg", createdAt: serverTimestamp() }); added.push("Game"); gameDataCache[demoGameId] = "Demo Game (BGMI)"; } else { const games = gamesSnap.val(); demoGameId = Object.keys(games)[0]; gameDataCache = Object.entries(games).reduce((acc, [id, data]) => { acc[id] = data.name; return acc; }, {}); } const promoRef = ref(db, 'promotions'); const promoSnap = await get(promoRef); if (!promoSnap.exists() || promoSnap.size === 0) { await set(push(promoRef), { imageUrl: "https://i.ibb.co/RGmQ420n/20250418-150709.jpg", link: "#", createdAt: serverTimestamp() }); added.push("Promotion"); } if (demoGameId) { const tRef = ref(db, 'tournaments'); const tSnap = await get(tRef); if (!tSnap.exists() || tSnap.size === 0) { await set(push(tRef), { gameId: demoGameId, name: "Weekend Demo Clash", startTime: now + 86400000, status: "upcoming", entryFee: 10, prizePool: 100, perKillPrize: 2, maxPlayers: 50, tags: ["Demo", "Squad"], description: "Sample tournament details.", roomId: null, roomPassword: null, showIdPass: false, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); added.push("Tournament"); } } const usersRef = ref(db, 'users'); const usersSnap = await get(usersRef); let demoUserNeeded = true; if(usersSnap.exists()){ usersSnap.forEach(uSnap => { if(uSnap.key !== designatedAdminUid) demoUserNeeded = false; }); } if(demoUserNeeded && auth) { try { const demoEmail = `demo${Date.now().toString().slice(-5)}@example.com`, demoPass = "password", cred = await createUserWithEmailAndPassword(auth, demoEmail, demoPass), uid = cred.user.uid, code = Math.random().toString(36).substring(2, 10).toUpperCase(); await set(ref(db, `users/${uid}`), { uid: uid, email: demoEmail, displayName: "Demo User", balance: 50, winningCash: 10, bonusCash: 5, status: 'active', createdAt: serverTimestamp(), referralCode: code, isAdmin: false, referralEarnings: 0, totalEarnings: 0, totalMatches: 0, wonMatches: 0 }); added.push("User (Demo)"); console.log("Created demo user:", demoEmail); } catch (userErr) { console.error("Failed demo user creation:", userErr); } } const settingsRef = ref(db, 'settings'); const settingsSnap = await get(settingsRef); if (!settingsSnap.exists()) { const demoSettings = { appName: "Demo Gaming App", logoUrl: "https://i.ibb.co/BvH3m14/Chat-GPT-Image-Apr-18-2025-05-54-04-PM.png", minWithdraw: 50, referralBonus: 5, supportContact: "support@demo.com", upiDetails: "demo@upi", policyPrivacy: "Demo Privacy Policy.", policyTerms: "Demo Terms.", policyRefund: "Demo Refund Policy.", policyFairPlay: "Demo Fair Play Policy.", lastUpdated: serverTimestamp() }; await set(settingsRef, demoSettings); added.push("Settings"); appSettings = demoSettings; } if (added.length > 0) { showStatus(statusEl, `Demo data added for: ${added.join(', ')}. Refreshing...`, "success", 5000); if (added.includes("Game")) await loadGames(); if (added.includes("Promotion")) await loadPromotions(); if (added.includes("Tournament")) await loadTournaments(); if (added.includes("Settings")) await loadSettings(); if (added.includes("User (Demo)")) await loadUsers(); loadDashboardStats(); } else { showStatus(statusEl, "No demo data added (already exists?).", "info", 5000); } } catch (error) { console.error("Error adding demo data:", error); showStatus(statusEl, `Error adding demo data: ${error.message}. Check Rules.`, "danger", false); } finally { showLoader(false); elements.addDemoDataBtn.disabled = false; } }


        // --- Realtime Admin Listeners Setup --- (Only count listener)
        function setupRealtimeAdminListeners() {
            if (!db || !currentAdminUser || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Setting up realtime count listeners...");
            detachAllAdminListeners(); // Ensure clean slate

            // Pending Withdrawal Count
            const pendingQuery = query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending'));
            const countKey = 'pendingWithdrawalsCount';
            dbListeners[countKey] = onValue(pendingQuery, (snapshot) => {
                 const count = snapshot.exists() ? snapshot.size : 0; console.log("Realtime pending withdrawal count:", count);
                 if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = count; elements.pendingWithdrawalCountBadge.style.display = count > 0 ? 'inline-block' : 'none'; }
                 if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = count;
            }, error => {
                console.error("Error listening to pending withdrawals count:", error);
                 if (elements.pendingWithdrawalCountBadge) { elements.pendingWithdrawalCountBadge.textContent = 'Err'; elements.pendingWithdrawalCountBadge.style.display = 'inline-block'; }
                 if (elements.dashboardSection?.classList.contains('active') && elements.statPendingWithdrawals) elements.statPendingWithdrawals.textContent = 'Error';
                 if (error?.message?.includes("index")) showStatus(elements.dashboardStatus, `Count error. Add index '.indexOn': 'status' to '/withdrawals'.`, "danger", false);
                 try { if (dbListeners[countKey]) { off(pendingQuery, 'value', dbListeners[countKey]); delete dbListeners[countKey]; console.log("Detached failed count listener."); } } catch(e) { console.warn("Could not detach failed count listener.", e); }
            });

             console.log("Realtime listeners setup initiated (Count Badge). Other lists load on section view.");
        }

        function detachAllAdminListeners() { // Detaches specific listeners based on keys
             if (!db || Object.keys(dbListeners).length === 0) return;
             console.log("Detaching admin listeners:", Object.keys(dbListeners));
             Object.keys(dbListeners).forEach(key => {
                 try {
                      if (key === 'pendingWithdrawalsCount') off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo('pending')), 'value', dbListeners[key]);
                      else if (key === 'users') off(ref(db, 'users'), 'value', dbListeners[key]);
                      else if (key.startsWith('withdrawals-')) off(query(ref(db, 'withdrawals'), orderByChild('status'), equalTo(key.split('-')[1])), 'value', dbListeners[key]);
                      else console.warn("Unknown listener key, cannot detach automatically:", key);
                      console.log("Detached listener:", key);
                 } catch (e) { console.warn(`Could not detach listener ${key}`, e); }
             });
             dbListeners = {};
             console.log("Finished detaching listeners.");
        }

        // --- Modal Opening/Population Functions ---

        // *** NEW: openEditGameModal ***
        async function openEditGameModal(gameId) {
            if (!db || !gameId || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Opening edit game modal for ID:", gameId);
            showLoader(true);
            elements.gameForm.reset();
            clearStatus(elements.gameStatus);
            const imgbbStatusEl = elements.gameForm.querySelector('.imgbb-upload-status');
            if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; }

            try {
                const snapshot = await get(ref(db, `games/${gameId}`));
                if (!snapshot.exists()) throw new Error(`Game ${gameId} not found.`);
                const game = snapshot.val();

                elements.gameModalTitle.textContent = "Edit Game";
                elements.gameEditId.value = gameId; // Set the hidden ID
                elements.gameNameInput.value = game.name || '';
                elements.gameImageUrlInput.value = game.imageUrl || '';
                // Clear file input as we prioritize URL on load
                elements.gameImageFileInput.value = '';

                getModalInstance(elements.gameModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit game modal:", error);
                showStatus(elements.gamesStatus, `Error loading game for edit: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        // *** NEW: openEditPromotionModal ***
        async function openEditPromotionModal(promoId) {
            if (!db || !promoId || !isDesignatedAdmin(currentAdminUser)) return;
            console.log("Opening edit promotion modal for ID:", promoId);
            showLoader(true);
            elements.promotionForm.reset();
            clearStatus(elements.promotionStatus);
            const imgbbStatusEl = elements.promotionForm.querySelector('.imgbb-upload-status');
             if (imgbbStatusEl) { imgbbStatusEl.textContent = ''; imgbbStatusEl.style.display = 'none'; }

            try {
                const snapshot = await get(ref(db, `promotions/${promoId}`));
                if (!snapshot.exists()) throw new Error(`Promotion ${promoId} not found.`);
                const promo = snapshot.val();

                elements.promotionModalTitle.textContent = "Edit Promotion";
                elements.promotionEditId.value = promoId; // Set hidden ID
                elements.promoImageUrlInput.value = promo.imageUrl || '';
                elements.promoLinkInput.value = promo.link || '';
                elements.promoImageFileInput.value = ''; // Clear file input

                getModalInstance(elements.promotionModalEl)?.show();
            } catch (error) {
                console.error("Error opening edit promotion modal:", error);
                showStatus(elements.promotionsStatus, `Error loading promotion for edit: ${error.message}`, "danger", false);
            } finally {
                showLoader(false);
            }
        }

        // Other modal functions (populateGameSelect, openEditTournamentModal, openUserModal, openRegisteredPlayersModal) remain largely the same as previous version

        async function populateGameSelect(selectedValue = null) { if (!elements.tournamentGameSelect) return; const select = elements.tournamentGameSelect; select.innerHTML = '<option value="">Loading...</option>'; select.disabled = true; try { if (Object.keys(gameDataCache).length === 0) await loadGames(); if (Object.keys(gameDataCache).length > 0) { select.innerHTML = '<option value="">-- Select Game --</option>'; const sorted = Object.entries(gameDataCache).sort(([, a], [, b]) => a.localeCompare(b)); sorted.forEach(([id, name]) => { const opt = document.createElement('option'); opt.value = id; opt.textContent = sanitizeHTML(name); select.appendChild(opt); }); if (selectedValue) select.value = selectedValue; } else { select.innerHTML = '<option value="">No Games Available</option>'; } } catch (error) { console.error("Error populating game select:", error); select.innerHTML = '<option value="">Error Loading</option>'; } finally { select.disabled = false; } }
        async function openEditTournamentModal(tournamentId) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; console.log("Opening edit tournament modal:", tournamentId); showLoader(true); clearStatus(elements.addTournamentStatus); elements.tournamentForm.reset(); currentEditingTournamentId = tournamentId; try { const snapshot = await get(ref(db, `tournaments/${tournamentId}`)); if (!snapshot.exists()) throw new Error(`Tournament ${tournamentId} not found.`); const t = snapshot.val(); await populateGameSelect(t.gameId); elements.tournamentModalTitle.textContent = "Edit Tournament"; elements.tournamentEditId.value = tournamentId; elements.tournamentNameInput.value = t.name || ''; if (t.startTime) { try { const d = new Date(t.startTime); if (!isNaN(d)) { const offset = d.getTimezoneOffset() * 60000; elements.tournamentStartTimeInput.value = new Date(d - offset).toISOString().slice(0, 16); } } catch(e){console.warn("Err fmt date",e);}} elements.tournamentStatusSelect.value = t.status || 'upcoming'; elements.tournamentEntryFeeInput.value = t.entryFee ?? 0; elements.tournamentPrizePoolInput.value = t.prizePool ?? 0; elements.tournamentPerKillInput.value = t.perKillPrize ?? 0; elements.tournamentMaxPlayersInput.value = t.maxPlayers ?? 0; elements.tournamentTagsInput.value = (t.tags || []).join(', '); elements.tournamentDescriptionInput.value = t.description || ''; elements.tournamentRoomIdInput.value = t.roomId || ''; elements.tournamentRoomPasswordInput.value = t.roomPassword || ''; elements.tournamentShowIdPassCheckbox.checked = t.showIdPass || false; getModalInstance(elements.addTournamentModalEl)?.show(); } catch (error) { console.error("Error opening edit tournament modal:", error); showStatus(elements.tournamentsStatus, `Error loading tournament: ${error.message}`, "danger", false); currentEditingTournamentId = null; } finally { showLoader(false); } }
        async function openUserModal(userId) { if (!db || !userId || !isDesignatedAdmin(currentAdminUser)) return; console.log("Opening user modal:", userId); showLoader(true); clearStatus(elements.balanceUpdateStatus); elements.updateBalanceForm.reset(); elements.userDetailReferredBy.textContent = "N/A"; elements.userDetailReferredCount.textContent = "N/A"; try { let user; if (fullUserDataCache[userId] && fullUserDataCache[userId].status !== 'error' && fullUserDataCache[userId].status !== 'deleted') { user = fullUserDataCache[userId]; console.log("Using cached user data."); } else { console.log("Fetching user data..."); const snapshot = await get(ref(db, `users/${userId}`)); if (!snapshot.exists()) throw new Error(`User ${userId} not found.`); user = snapshot.val(); user.uid = userId; fullUserDataCache[userId] = user; } elements.userModalTitle.textContent = `User: ${sanitizeHTML(user.displayName || 'N/A')}`; elements.userDetailUid.textContent = userId; elements.userDetailEmail.textContent = sanitizeHTML(user.email || 'N/A'); elements.userDetailName.textContent = sanitizeHTML(user.displayName || 'N/A'); elements.userDetailCreatedAt.textContent = formatDate(user.createdAt); elements.userDetailBalance.textContent = formatCurrency(user.balance); elements.userDetailWinning.textContent = formatCurrency(user.winningCash); elements.userDetailBonus.textContent = formatCurrency(user.bonusCash); elements.editUserUid.value = userId; elements.userDetailReferralCode.textContent = user.referralCode || 'N/A'; const status = user.status || 'active'; elements.userDetailStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1); elements.userDetailStatus.className = `fw-bold text-${status === 'active' ? 'success' : 'danger'}`; elements.userBlockBtn.textContent = status === 'active' ? 'Block User' : 'Unblock User'; elements.userBlockBtn.className = `btn btn-sm ${status === 'active' ? 'btn-danger' : 'btn-success'}`; elements.userBlockBtn.dataset.id = userId; elements.userBlockBtn.dataset.action = status === 'active' ? 'block' : 'unblock'; elements.userDeleteBtn.dataset.id = userId; getModalInstance(elements.userModalEl)?.show(); } catch (error) { console.error("Error opening user modal:", error); showStatus(elements.usersStatus, `Error loading user: ${error.message}`, "danger", false); } finally { showLoader(false); } }
        async function openRegisteredPlayersModal(tournamentId, tournamentName) { if (!db || !tournamentId || !isDesignatedAdmin(currentAdminUser)) return; console.log(`Opening registered players: T:${tournamentId}`); elements.registeredPlayersModalTitle.textContent = "Registered Players"; elements.registeredPlayersTournamentName.textContent = tournamentName || "N/A"; elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3"><div class="spinner-border spinner-border-sm"></div></td></tr>`; clearStatus(elements.registeredPlayersStatus); getModalInstance(elements.registeredPlayersModalEl)?.show(); try { const playersRef = ref(db, `tournaments/${tournamentId}/registeredPlayers`); const snapshot = await get(playersRef); if (!snapshot.exists()) { elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-muted">No players registered.</td></tr>`; return; } const registeredData = snapshot.val(); const userIds = Object.keys(registeredData); let tableHtml = ''; let fetchedCount = 0; const promises = userIds.map(async (uid) => { try { let u = fullUserDataCache[uid]; if (!u) { const uSnap = await get(ref(db, `users/${uid}`)); if (uSnap.exists()) { u = uSnap.val(); u.uid = uid; fullUserDataCache[uid] = u; } else u = { uid: uid, displayName: 'Not Found', email: 'N/A' }; } return { user: u, joinedAt: registeredData[uid]?.joinedAt }; } catch (err) { console.warn(`Err fetch user ${uid} for list:`, err); return { user: { uid: uid, displayName: 'Error Fetching', email: 'N/A' }, joinedAt: registeredData[uid]?.joinedAt }; } }); const results = await Promise.allSettled(promises); results.forEach(res => { if (res.status === 'fulfilled' && res.value) { const { user, joinedAt } = res.value; tableHtml += `<tr><td><small class="text-muted">${sanitizeHTML(user.uid)}</small></td><td>${sanitizeHTML(user.displayName)}</td><td>${sanitizeHTML(user.email)}</td><td>${formatDate(joinedAt)}</td></tr>`; fetchedCount++; } }); elements.registeredPlayersTableBody.innerHTML = tableHtml || `<tr><td colspan="4" class="text-center p-3 text-muted">Could not load player details.</td></tr>`; elements.registeredPlayersModalTitle.textContent = `Registered Players (${fetchedCount})`; } catch (error) { console.error("Error loading registered players:", error); elements.registeredPlayersTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-3 text-danger">Error: ${error.message}.</td></tr>`; showStatus(elements.registeredPlayersStatus, `Error: ${error.message}`, 'danger'); } }


        // --- Event Listeners Initialization ---
        function initializeAdminEventListeners() {
            console.log("Initializing Admin Event Listeners...");
            if (!auth || !db) { console.error("Cannot init listeners: Firebase not ready."); return; }

            // Auth & Setup
            elements.adminSetupForm?.addEventListener('submit', setupAdmin);
            elements.adminLoginForm?.addEventListener('submit', loginAdmin);
            elements.adminLogoutBtn?.addEventListener('click', logoutAdminUser);
            // Sidebar Navigation
            elements.sidebarLinks?.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const sectionId = link.dataset.section; if (sectionId && !link.classList.contains('active')) { showAdminSection(sectionId); } else { getOffcanvasInstance(elements.sidebar)?.hide(); } }); });
            // Save Buttons (direct click)
            elements.saveGameBtn?.addEventListener('click', saveGame); // Handles Add/Edit
            elements.savePromotionBtn?.addEventListener('click', savePromotion); // Handles Add/Edit
            elements.saveTournamentBtn?.addEventListener('click', saveTournament);
            elements.saveNewUserBtn?.addEventListener('click', saveNewUser);
            // Form Submissions
            elements.appSettingsForm?.addEventListener('submit', saveSettings);
            elements.updateBalanceForm?.addEventListener('submit', updateUserBalance);
            // Modal Triggers / Actions in Modals
            elements.addNewGameBtn?.addEventListener('click', () => { // Open Add Game Modal
                 elements.gameForm?.reset(); elements.gameEditId.value = ''; elements.gameModalTitle.textContent = "Add New Game"; clearStatus(elements.gameStatus);
                 const imgbbEl = elements.gameForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';}
            });
             elements.addNewPromotionBtn?.addEventListener('click', () => { // Open Add Promotion Modal
                 elements.promotionForm?.reset(); elements.promotionEditId.value = ''; elements.promotionModalTitle.textContent = "Add New Promotion"; clearStatus(elements.promotionStatus);
                 const imgbbEl = elements.promotionForm?.querySelector('.imgbb-upload-status'); if(imgbbEl){ imgbbEl.textContent=''; imgbbEl.style.display='none';}
            });
            elements.addNewTournamentBtn?.addEventListener('click', () => { currentEditingTournamentId = null; elements.tournamentForm?.reset(); if(elements.tournamentModalTitle) elements.tournamentModalTitle.textContent = "Add New Tournament"; clearStatus(elements.addTournamentStatus); populateGameSelect(); });
            elements.userBlockBtn?.addEventListener('click', toggleUserBlock);
            elements.userDeleteBtn?.addEventListener('click', (e) => { const userId = e.target.closest('button')?.dataset.id; if (userId) deleteUser(userId); });
            elements.approveWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            elements.rejectWithdrawalBtn?.addEventListener('click', processWithdrawalAction);
            // Demo Data
            elements.addDemoDataBtn?.addEventListener('click', addDemoData);
            // User Search
            elements.userSearchInput?.addEventListener('input', filterUsers);
            
            // =========================
            // NEW: THEME EVENT LISTENERS
            // =========================
            elements.saveThemeBtn?.addEventListener('click', saveTheme);
            elements.resetThemeBtn?.addEventListener('click', resetTheme);
            elements.previewDefaultThemeBtn?.addEventListener('click', () => populateThemePickers(defaultTheme));
            elements.previewCrimsonThemeBtn?.addEventListener('click', () => populateThemePickers(crimsonTheme));
            elements.previewOceanicThemeBtn?.addEventListener('click', () => populateThemePickers(oceanicTheme));
            // Sync color picker with text input and vice-versa
            elements.customThemeForm?.addEventListener('input', (e) => {
                if (e.target.matches('input[type="color"]')) {
                    const textInput = e.target.parentElement.querySelector(`input[type="text"][data-target="${e.target.id}"]`);
                    if(textInput) textInput.value = e.target.value;
                } else if (e.target.matches('input[type="text"]')) {
                    const colorInput = getElement(e.target.dataset.target);
                    if(colorInput && /^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        colorInput.value = e.target.value;
                    }
                }
            });
            
            // Delegated Event Listener for table actions and copy buttons
            document.body.addEventListener('click', (event) => {
                 const target = event.target; const actionButton = target.closest('button[data-id]'); const copyIcon = target.closest('.copy-btn[data-target]');

                 if (actionButton) {
                     const targetId = actionButton.dataset.id; if (!targetId) return;
                     if (actionButton.classList.contains('btn-delete-game')) deleteGame(targetId);
                     else if (actionButton.classList.contains('btn-edit-game')) openEditGameModal(targetId); // Added
                     else if (actionButton.classList.contains('btn-delete-promo')) deletePromotion(targetId);
                     else if (actionButton.classList.contains('btn-edit-promo')) openEditPromotionModal(targetId); // Added
                     else if (actionButton.classList.contains('btn-delete-tournament')) deleteTournament(targetId);
                     else if (actionButton.classList.contains('btn-edit-tournament')) openEditTournamentModal(targetId);
                     else if (actionButton.classList.contains('btn-view-user')) openUserModal(targetId);
                     else if (actionButton.classList.contains('btn-approve-withdrawal')) openWithdrawalActionModal(targetId, 'approve');
                     else if (actionButton.classList.contains('btn-reject-withdrawal')) openWithdrawalActionModal(targetId, 'reject');
                     else if (actionButton.classList.contains('btn-delete-user')) deleteUser(targetId);
                     else if (actionButton.classList.contains('btn-view-registered')) openRegisteredPlayersModal(targetId, actionButton.dataset.name);
                     return;
                 }
                 if (copyIcon) { copyToClipboard(copyIcon.dataset.target); return; }
            });
            // Modal Cleanup logic
             const resetModal = (modalEl, formEl, statusEl, idField = null, titleEl = null, defaultTitle = 'Add New Item', imgbbSel = '.imgbb-upload-status') => {
                  modalEl?.addEventListener('hidden.bs.modal', () => {
                       formEl?.reset(); if(statusEl) clearStatus(statusEl);
                       const imgbbStat = formEl?.querySelector(imgbbSel); if(imgbbStat) { imgbbStat.textContent=''; imgbbStat.style.display='none'; }
                       if (idField) idField.value = ''; // Clear edit ID
                       if (titleEl) titleEl.textContent = defaultTitle; // Reset title
                       if (modalEl === elements.addTournamentModalEl) currentEditingTournamentId = null;
                       if (modalEl === elements.userModalEl) elements.editUserUid.value = '';
                       if (modalEl === elements.withdrawalActionModalEl) currentWithdrawalAction = { id: null, type: null, userId: null };
                       currentEditingItemId = null; // Reset generic edit ID
                  });
             };
             resetModal(elements.gameModalEl, elements.gameForm, elements.gameStatus, elements.gameEditId, elements.gameModalTitle, 'Add New Game');
             resetModal(elements.promotionModalEl, elements.promotionForm, elements.promotionStatus, elements.promotionEditId, elements.promotionModalTitle, 'Add New Promotion');
             resetModal(elements.addTournamentModalEl, elements.tournamentForm, elements.addTournamentStatus, elements.tournamentEditId, elements.tournamentModalTitle, 'Add New Tournament', null);
             resetModal(elements.addUserModalEl, elements.addUserForm, elements.addUserStatus, null, null, '', null);
             resetModal(elements.userModalEl, elements.updateBalanceForm, elements.balanceUpdateStatus, elements.editUserUid, null, '', null);
             resetModal(elements.withdrawalActionModalEl, null, elements.withdrawalActionStatus, null, null, '', null);
             resetModal(elements.registeredPlayersModalEl, null, elements.registeredPlayersStatus, null, null, '', null);

             console.log("Admin Event Listeners Initialized.");
        }

        // --- Filter Users Function ---
        function filterUsers() {
            const searchTerm = elements.userSearchInput.value.toLowerCase().trim();
            const filteredUsers = Object.values(fullUserDataCache).filter(user =>
                user.displayName?.toLowerCase().includes(searchTerm) || user.email?.toLowerCase().includes(searchTerm)
            );
            renderUsersTable(filteredUsers);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin Panel DOM Loaded.");
            if (!app || !auth || !db) {
                console.error("DOM loaded, but Firebase services not initialized. Check config object.");
                // The error message should already be displayed by the catch block during initialization
                return;
            }
            initializeAdminEventListeners();
            onAuthStateChanged(auth, handleAdminAuthStateChange); // Main entry point
        });

    </script>

</body>
</html>